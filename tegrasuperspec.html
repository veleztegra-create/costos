<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tegra - Technical Spec Manager</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            /* === COLORES OFICIALES TEGRA === */
            --tegra-navy: #002855;       
            --tegra-green: #78BE20;      
            --tegra-gray: #636466;       
            
            /* Variables de aplicación */
            --primary: var(--tegra-navy);
            --accent: var(--tegra-green);
            --secondary: #edf2f7;
            --text-dark: #1a202c;
            --text-light: #4a5568;
            --border: #cbd5e0;
            --success: var(--tegra-green);
            --warning: #ed8936;
            --error: #e53e3e;
            --shadow: 0 4px 6px -1px rgba(0, 40, 85, 0.15);
            --radius: 6px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        body {
            background: #f4f7fa;
            min-height: 100vh;
            padding: 20px;
            color: var(--text-dark);
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border-top: 5px solid var(--accent);
        }

        /* Header */
        .app-header {
            background: var(--primary);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start; 
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .logo-section { display: flex; align-items: center; gap: 25px; }
        
        .app-logo svg { height: 40px; width: auto; fill: white; }
        .app-title { font-size: 1.4rem; font-weight: 300; letter-spacing: 1px; }
        .app-subtitle { font-size: 0.8rem; opacity: 0.7; letter-spacing: 0.5px; text-transform: uppercase; }
        
        .client-section {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.1);
            padding: 5px 15px;
            border-radius: 4px;
            margin-left: 20px;
        }
        
        .client-label {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--accent);
            letter-spacing: 0.5px;
        }

        .client-logo-wrapper {
            height: 35px;
            display: flex;
            align-items: center;
        }
        
        .client-logo-wrapper svg {
            fill: white; 
            max-height: 100%;
            width: auto;
        }
        
        /* New Folder Input in Header */
        .header-actions {
            display: flex; 
            flex-direction: column; 
            align-items: flex-end; 
            gap: 5px;
        }

        .folder-input-container {
            display: flex; 
            align-items: center; 
            gap: 5px;
        }

        /* CAMBIO: Aumento de tamaño del input del folder */
        .header-actions .form-control {
            width: 150px; /* Ancho aumentado, doble de espacio */
            padding: 4px 8px; 
            font-size: 13px;
            text-align: right;
            border: none;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-weight: bold;
        }
        .header-actions .form-control:focus {
             background: white;
             color: var(--text-dark);
             box-shadow: none;
        }

        /* Navigation */
        .app-nav { background: white; padding: 0 30px; border-bottom: 1px solid var(--border); }
        .nav-tabs { display: flex; list-style: none; gap: 20px; }
        .nav-tab {
            padding: 18px 10px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: var(--text-light);
            transition: all 0.2s;
            font-size: 0.95rem;
        }
        .nav-tab:hover { color: var(--primary); }
        .nav-tab.active { color: var(--primary); border-bottom-color: var(--accent); }

        /* Content */
        .app-main { padding: 30px; min-height: 600px; }
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards */
        .card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            border: 1px solid var(--border);
        }
        .card-header {
            background: #f8fafc;
            padding: 15px 25px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-title { font-size: 1.05rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .card-body { padding: 25px; }

        /* Forms */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 6px; font-weight: 700; font-size: 0.85rem; color: var(--text-dark); text-transform: uppercase; }
        .form-control {
            width: 100%; padding: 10px 12px;
            border: 1px solid var(--border); border-radius: var(--radius);
            font-size: 14px; transition: border 0.2s;
            background: #fafafa;
        }
        .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(0, 40, 85, 0.1); background: white; }

        /* Buttons */
        .btn {
            padding: 10px 20px; border: none; border-radius: 4px;
            font-weight: 600; cursor: pointer; transition: all 0.2s;
            display: inline-flex; align-items: center; gap: 8px; font-size: 14px;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .btn:active { transform: translateY(1px); }
        .btn-primary { background: var(--primary); }
        .btn-primary:hover { background: #004B8D; }
        
        .btn-white-base { 
            background: #ffffff; 
            color: #333; 
            border: 2px solid #cbd5e0; 
        }
        .btn-white-base:hover { background: #f0f0f0; border-color: #999; }

        .btn-success { background: var(--success); }
        .btn-success:hover { background: #6aa81c; }
        
        .btn-warning { background: var(--warning); }
        .btn-danger { background: var(--error); }
        
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-light); }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
        
        .btn-sm { padding: 6px 12px; font-size: 11px; }
        .btn-lg { padding: 14px 28px; font-size: 15px; }

        /* Sequences & Tables */
        .sequence-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; }
        .sequence-table th { 
            background: var(--primary); color: white; padding: 12px 6px; text-align: left; 
            font-weight: 600; border-bottom: 3px solid var(--accent); font-size: 11px;
        }
        .sequence-table td { padding: 10px 6px; border-bottom: 1px solid var(--border); }
        .sequence-table tr:nth-child(even) { background: #f8fafc; }
        .sequence-table tr:hover { background: #eff6ff; }

        .color-sequence { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .color-item {
            display: flex; align-items: center; gap: 10px;
            padding: 10px; background: #f8fafc;
            border-radius: var(--radius); border-left: 4px solid var(--primary);
            border: 1px solid var(--border); border-left-width: 4px;
        }
        /* Estilo para el input de la letra de pantalla (Editable) */
        .color-item .form-control[title="Letra/Número de Pantalla"] {
            width: 50px; 
            text-align: center; 
            font-weight: bold;
            border: 2px solid var(--accent);
            padding: 5px;
        }

        .badge { padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: bold; color: white; text-transform: uppercase; }
        .badge-blocker { background: var(--text-dark); }
        .badge-white { background: #9ca3af; color: white; }
        .badge-color { background: var(--primary); }

        /* File Upload & Preview */
        .file-upload-area {
            border: 2px dashed var(--border); border-radius: var(--radius);
            padding: 30px; text-align: center; cursor: pointer;
            background: #f8fafc; transition: all 0.3s;
        }
        .file-upload-area:hover { border-color: var(--accent); background: rgba(120, 190, 32, 0.05); }
        
        .image-preview { max-width: 100%; max-height: 250px; border-radius: var(--radius); margin-top: 15px; display: none; box-shadow: var(--shadow); border: 1px solid var(--border); }

        /* Dashboard */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); text-align: center; border-top: 4px solid var(--accent); }
        .stat-number { font-size: 2.5rem; font-weight: bold; color: var(--primary); }

        /* Status Messages */
        .status-message {
            position: fixed; bottom: 20px; right: 20px;
            padding: 15px 25px; border-radius: var(--radius);
            color: white; font-weight: bold; display: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        .status-success { background: var(--success); }
        .status-error { background: var(--error); }
        .status-warning { background: var(--warning); }
        @keyframes slideIn { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Logos Footer */
        .logos-container {
            text-align: center; padding: 30px;
            background: #f8fafc; border-top: 1px solid var(--border);
            display: flex; justify-content: center; align-items: center; gap: 40px;
        }

        @media print {
            .no-print, .app-nav, .header-actions { display: none !important; }
            .app-container { box-shadow: none; border: none; }
            body { background: white; }
            .card { box-shadow: none; border: 1px solid #ddd; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="logo-section">
                <div class="app-logo">
                    <svg viewBox="0 0 145.94 39.05" xmlns="http://www.w3.org/2000/svg">
                        <path d="M42.24,12.37v1.93h6.91v15.25h4.21v-15.25h6.91v-3.88h-16.1l-1.93,1.95ZM92.06,20.31v1.87h4.24v2.73c-.53.38-1.13.67-1.8.86-.67.19-1.39.29-2.16.29-.84,0-1.61.15-2.32-.45-.71-.3-1.33-.72-1.84-1.27-.52-.55-.92-1.19-1.2-1.93-.28-.74-.42-1.54-.42-2.42v-.05c0-.82.14-1.59.42-2.31.28-.72.67-1.35,1.18-1.89.5-.54,1.08-.97,1.75-1.28.66-.32,1.38-.48,2.15-.48.55,0,1.05.05,1.5.14.46.09.88.22,1.27.38.39.16.77.36,1.13.6.25.16.49.34.74.54l2.94-2.97c-.47-.4-.96-.75-1.46-1.07-.53-.33-1.09-.6-1.7-.82-.6-.22-1.25-.39-1.95-.51-.7-.12-1.48-.18-2.34-.18-1.44,0-2.77.26-4,.78-1.23.52-2.29,1.23-3.18,2.13-.89.9-1.59,1.95-2.09,3.14-.50,1.19-.75,2.47-.75,3.84v.05c0,1.42.25,2.73.74,3.94.49,1.2,1.18,2.24,2.06,3.12.88.87,1.94,1.56,3.17,2.05,1.23.49,2.59.74,4.09.74,1.75,0,3.3-.3,4.66-.89,1.36-.59,2.53-1.31,3.51-2.15v-8.31h-6.56l-1.74,1.76ZM68.15,21.8h9.02v-3.74h-9.02v-3.88h10.25v-3.74h-12.55l-1.86,1.88v17.26h14.54v-3.74h-10.39v-4.02ZM114.24,10.43h-8.75v19.13h4.21v-6.12h3.31l4.1,6.12h2.57l1.39-1.4-3.71-5.43c1.22-.46,2.21-1.17,2.97-2.15.76-.97,1.13-2.24,1.13-3.79v-.05c0-1.82-.55-3.28-1.64-4.37-1.29-1.29-3.15-1.94-5.58-1.94ZM117.19,17.03c0,.82-.28,1.48-.83,1.98-.56.49-1.35.74-2.39.74h-4.26v-5.52h4.18c1.04,0,1.85.23,2.43.69.58.46.87,1.14.87,2.06v.05ZM136.7,10.29h-3.88l-8.2,19.27h4.29l1.75-4.29h8.09l1.75,4.29h1.97l1.7-1.72-7.47-17.55ZM132.16,21.58l2.54-6.2,2.54,6.2h-5.08Z"/>
                        <g><polygon points="7.44 31.38 6.59 32.24 6.88 33.39 8.03 33.68 8.89 32.83 8.59 31.68 7.44 31.38"/><polygon points="6.79 28.67 7.94 28.97 10.41 26.5 10.11 25.35 8.96 25.05 6.49 27.52 6.79 28.67"/><polygon points="10.54 14.61 9.4 14.31 6.93 16.78 7.23 17.93 8.37 18.23 10.85 15.76 10.54 14.61"/><polygon points="26.38 22.79 25.06 24.11 25.36 25.26 26.5 25.56 27.82 24.24 27.52 23.09 26.38 22.79"/><path d="M21.9,36.93l.3,1.15,1.15.3.85-.85-.3-1.15-1.15-.3-.85.85ZM18.01,29.21l-.3-1.15.85-.85,1.15.3.3,1.15-.85.85-1.15-.3ZM18.83,19.56l-.3-1.15,1.5-1.5,1.15.3.3,1.15-1.5,1.5-1.15-.3ZM20.85,14.61l-.3-1.15,1.5-1.5,1.15.3.3,1.15-1.5,1.5-1.15-.3ZM14.33,15.34l-.3-1.14,3.78-3.68,1.14.3.3,1.14-3.78,3.68-1.15-.3ZM24.21,10.68l-.3-1.15,2.17-2.17,1.14.3.3,1.14-2.17,2.17-1.14-.3ZM20.59,9.12l-.3-1.15.85-.85,1.15.3.3,1.15-.85.85-1.15-.3ZM15.06,8.82l-.3-1.15,1.5-1.5,1.15.3.3,1.15-1.5,1.5-1.15-.3ZM25.51,0l-4.9,4.9-1.14-.3-.3-1.14,3.46-3.46H0v9.55h4.54l-1.67,1.67.3,1.14,1.15.3,3.12-3.12h.02l2.59-2.59,1.14.3.3,1.14-.57.57-1.81,1.78.3,1.15,1.15.3,2.5-2.45v8.41l-3.99,3.99.3,1.15,1.15.3,4.62-4.62,1.07.28.3,1.15-1.42,1.42-.93.93-.84.84-1.78,1.78.3,1.15,1.14.3,3.56-3.56.27-.27,1.14.3.3,1.14-4.64,4.64h-.03s-2.52,2.51-2.52,2.51l.31,1.16,1.17.31,2.52-2.52h0s.3-.32.3-.32l1.14.3.3,1.15-3.75,3.75h0s-2.17,2.18-2.17,2.18l.3,1.14,1.15.3,6.35-6.35,1.14.3.3,1.15-2.82,2.77.3,1.14,1.15.3,5.15-5.1v-2.89h0s-1.24,1.24-1.24,1.24l-1.15-.3-.3-1.14,3.43-3.41-.3-1.15-.45-.12-.71-.19-1.05,1.05-1.14-.3-.3-1.14,6.16-6.31-.3-1.15-1.14-.3-1.51,1.51v-4.34l5.25-4.76h7.28V0h-10.92Z"/></g>
                    </svg>
                </div>
                <div>
                    <h1 class="app-title">Technical Spec Manager</h1>
                    <p class="app-subtitle">Sistema de gestión de especificaciones técnicas</p>
                </div>
                
                <div class="client-section">
                    <span class="client-label">CUSTOMER / CLIENTE:</span>
                    <div class="client-logo-wrapper">
                        <svg id="logoCliente" width="80" height="30" viewBox="0 0 100 35"></svg>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <div class="folder-input-container">
                     <span class="client-label" style="font-size: 0.9rem; color: var(--accent);"># FOLDER:</span>
                     <input type="text" id="folder-num" class="form-control" placeholder="#####">
                </div>
                <div id="current-datetime" style="font-size: 0.9rem; padding-top: 5px;"></div>
            </div>
        </header>

        <nav class="app-nav no-print">
            <ul class="nav-tabs">
                <li class="nav-tab active" onclick="showTab('dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</li>
                <li class="nav-tab" onclick="showTab('spec-creator')"><i class="fas fa-file-alt"></i> Crear Spec</li>
                <li class="nav-tab" onclick="showTab('saved-specs')"><i class="fas fa-database"></i> Guardadas</li>
            </ul>
        </nav>

        <main class="app-main">
            <div id="dashboard" class="tab-content active">
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-specs">0</div>
                        <div class="stat-label">Specs Totales</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="today-specs">0</div>
                        <div class="stat-label">Creadas Hoy</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body" style="text-align: center;">
                        <h2><i class="fas fa-rocket"></i> Acciones Rápidas</h2>
                        <div style="margin-top: 20px; display: flex; gap: 15px; justify-content: center;">
                            <button class="btn btn-primary btn-lg" onclick="showTab('spec-creator')">Nueva Spec</button>
                            <button class="btn btn-secondary btn-lg" onclick="document.getElementById('excelFile').click()" style="background:var(--text-light);">Cargar Excel</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="spec-creator" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-info-circle"></i> Información General</h2>
                        <div class="no-print">
                            <button class="btn btn-warning btn-sm" onclick="document.getElementById('excelFile').click()">
                                <i class="fas fa-file-excel"></i> Cargar Excel
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">CLIENTE:</label>
                                <input type="text" id="customer" class="form-control" oninput="updateClientLogo()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">STYLE:</label>
                                <input type="text" id="style" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">COLORWAY:</label>
                                <input type="text" id="colorway" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">SEASON:</label>
                                <input type="text" id="season" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">PATTERN #:</label>
                                <input type="text" id="pattern" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">P.O. #:</label>
                                <input type="text" id="po" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">SAMPLE TYPE:</label>
                                <input type="text" id="sample-type" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">NAME / TEAM:</label>
                                <input type="text" id="name-team" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">GENDER:</label>
                                <input type="text" id="gender" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">DISEÑADOR:</label>
                                <select id="designer" class="form-control">
                                    <option value="">Seleccionar...</option>
                                    <option value="ELMER VELEZ">ELMER VELEZ</option>
                                    <option value="DANIEL HERNANDEZ">DANIEL HERNANDEZ</option>
                                    <option value="CINDY PINEDA">CINDY PINEDA</option>
                                    <option value="EDA">EDA</option>
                                    <option value="OTRO">OTRO</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-image"></i> Imagen de Referencia</h2>
                    </div>
                    <div class="card-body">
                        <div class="file-upload-area" onclick="document.getElementById('imageInput').click()">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: var(--primary);"></i>
                            <p>Clic para subir imagen</p>
                        </div>
                        <img id="imagePreview" class="image-preview" alt="Vista previa">
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-palette"></i> Colores y Tintas</h2>
                    </div>
                    <div class="card-body">
                        <div class="no-print" style="margin-bottom: 15px;">
                            <button class="btn btn-danger btn-sm" onclick="addColorItem('BLOCKER')">+ Blocker</button>
                            <button class="btn btn-white-base btn-sm" onclick="addColorItem('WHITE_BASE')">+ White Base</button>
                            <button class="btn btn-primary btn-sm" onclick="addColorItem('COLOR')">+ Color</button>
                        </div>
                        <div id="colors-container" class="color-sequence"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-print"></i> Condiciones de Impresión</h2>
                    </div>
                    <div class="card-body">
                        <div class="form-grid" style="margin-bottom: 20px;">
                             <div class="form-group">
                                <label class="form-label">TIPO DE TINTA:</label>
                                <select id="ink-type-select" class="form-control" onchange="applyInkPreset()">
                                    <option value="WATER">Water-base</option>
                                    <option value="PLASTISOL">Plastisol</option>
                                    <option value="SILICONE">Silicone</option>
                                </select>
                            </div>
                            <div class="form-group"><label class="form-label">INK TYPE:</label><input type="text" id="ink-type" class="form-control" value="AQUAFLEX MAGNA"></div>
                            <div class="form-group"><label class="form-label">TEMP:</label><input type="text" id="temp" class="form-control" value="320 °F"></div>
                            <div class="form-group"><label class="form-label">TIME:</label><input type="text" id="time" class="form-control" value="1:40 min"></div>
                            
                            <div class="form-group">
                                <label class="form-label">DIMENSIONS:</label>
                                <input type="text" id="dimensions" class="form-control" value='SIZE: (W) ##" X (H) ##"'>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">PLACEMENT (Ubicación):</label>
                                <select id="placement-select" class="form-control">
                                    <option value="FRONT">FRONT</option>
                                    <option value="BACK">BACK</option>
                                    <option value="TV. NUMBERS">TV. NUMBERS</option>
                                    <option value="SLEEVE">SLEEVE</option>
                                    <option value="CHEST">CHEST</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">PLACEMENT DETAILS:</label>
                                <input type="text" id="placement" class="form-control" value='#.#" FROM COLLAR SEAM'>
                            </div>

                            <div class="form-group">
                                <label class="form-label">SPECIALTIES:</label>
                                <input type="text" id="specialties" class="form-control" placeholder="Ej: HD, Metalico, Puff..." onchange="this.dataset.manual = 'true'">
                            </div>
                        </div>
                        
                        <h3 style="margin: 15px 0; font-size:1rem; color:var(--primary); border-bottom: 2px solid var(--accent); padding-bottom: 5px; display:inline-block;">Secuencia de Estaciones</h3>
                        <div id="print-sequence-table"></div>
                        
                         <div class="form-group" style="margin-top: 20px;">
                            <label class="form-label">SPECIAL INSTRUCTIONS:</label>
                            <textarea id="special-instructions" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                </div>

                <div class="card no-print">
                    <div class="card-body" style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button class="btn btn-primary btn-lg" onclick="downloadJSON()"><i class="fas fa-download"></i> Guardar / Descargar JSON</button>
                        <button class="btn btn-success btn-lg" onclick="exportPDF()"><i class="fas fa-file-pdf"></i> Exportar PDF</button>
                        <button class="btn btn-outline btn-lg" onclick="clearForm()" style="color: var(--text-light); border-color: var(--border);">Limpiar</button>
                    </div>
                </div>
            </div>

            <div id="saved-specs" class="tab-content">
                <div class="card">
                    <div class="card-header"><h2 class="card-title">Specs Guardadas (Browser)</h2></div>
                    <div class="card-body" id="saved-specs-list"></div>
                </div>
            </div>
        </main>

        <div class="logos-container">
            <svg width="150" height="40" viewBox="0 0 145.94 39.05" xmlns="http://www.w3.org/2000/svg">
                <path fill="#002855" d="M42.24,12.37v1.93h6.91v15.25h4.21v-15.25h6.91v-3.88h-16.1l-1.93,1.95ZM92.06,20.31v1.87h4.24v2.73c-.53.38-1.13.67-1.8.86-.67.19-1.39.29-2.16.29-.84,0-1.61.15-2.32-.45-.71-.3-1.33-.72-1.84-1.27-.52-.55-.92-1.19-1.2-1.93-.28-.74-.42-1.54-.42-2.42v-.05c0-.82.14-1.59.42-2.31.28-.72.67-1.35,1.18-1.89.5-.54,1.08-.97,1.75-1.28.66-.32,1.38-.48,2.15-.48.55,0,1.05.05,1.5.14.46.09.88.22,1.27.38.39.16.77.36,1.13.6.25.16.49.34.74.54l2.94-2.97c-.47-.4-.96-.75-1.46-1.07-.53-.33-1.09-.6-1.7-.82-.6-.22-1.25-.39-1.95-.51-.7-.12-1.48-.18-2.34-.18-1.44,0-2.77.26-4,.78-1.23.52-2.29,1.23-3.18,2.13-.89.9-1.59,1.95-2.09,3.14-.50,1.19-.75,2.47-.75,3.84v.05c0,1.42.25,2.73.74,3.94.49,1.2,1.18,2.24,2.06,3.12.88.87,1.94,1.56,3.17,2.05,1.23.49,2.59.74,4.09.74,1.75,0,3.3-.3,4.66-.89,1.36-.59,2.53-1.31,3.51-2.15v-8.31h-6.56l-1.74,1.76ZM68.15,21.8h9.02v-3.74h-9.02v-3.88h10.25v-3.74h-12.55l-1.86,1.88v17.26h14.54v-3.74h-10.39v-4.02ZM114.24,10.43h-8.75v19.13h4.21v-6.12h3.31l4.1,6.12h2.57l1.39-1.4-3.71-5.43c1.22-.46,2.21-1.17,2.97-2.15.76-.97,1.13-2.24,1.13-3.79v-.05c0-1.82-.55-3.28-1.64-4.37-1.29-1.29-3.15-1.94-5.58-1.94ZM117.19,17.03c0,.82-.28,1.48-.83,1.98-.56.49-1.35.74-2.39.74h-4.26v-5.52h4.18c1.04,0,1.85.23,2.43.69.58.46.87,1.14.87,2.06v.05ZM136.7,10.29h-3.88l-8.2,19.27h4.29l1.75-4.29h8.09l1.75,4.29h1.97l1.7-1.72-7.47-17.55ZM132.16,21.58l2.54-6.2,2.54,6.2h-5.08Z"/>
                <g><polygon fill="#002855" points="7.44 31.38 6.59 32.24 6.88 33.39 8.03 33.68 8.89 32.83 8.59 31.68 7.44 31.38"/><polygon fill="#002855" points="6.79 28.67 7.94 28.97 10.41 26.5 10.11 25.35 8.96 25.05 6.49 27.52 6.79 28.67"/><polygon fill="#002855" points="10.54 14.61 9.4 14.31 6.93 16.78 7.23 17.93 8.37 18.23 10.85 15.76 10.54 14.61"/><polygon fill="#002855" points="26.38 22.79 25.06 24.11 25.36 25.26 26.5 25.56 27.82 24.24 27.52 23.09 26.38 22.79"/><path fill="#002855" d="M21.9,36.93l.3,1.15,1.15.3.85-.85-.3-1.15-1.15-.3-.85.85ZM18.01,29.21l-.3-1.15.85-.85,1.15.3.3,1.15-.85.85-1.15-.3ZM18.83,19.56l-.3-1.15,1.5-1.5,1.15.3.3,1.15-1.5,1.5-1.15-.3ZM20.85,14.61l-.3-1.15,1.5-1.5,1.15.3.3,1.15-1.5,1.5-1.15-.3ZM14.33,15.34l-.3-1.14,3.78-3.68,1.14.3.3,1.14-3.78,3.68-1.15-.3ZM24.21,10.68l-.3-1.15,2.17-2.17,1.14.3.3,1.14-2.17,2.17-1.14-.3ZM20.59,9.12l-.3-1.15.85-.85,1.15.3.3,1.15-.85.85-1.15-.3ZM15.06,8.82l-.3-1.15,1.5-1.5,1.15.3.3,1.15-1.5,1.5-1.15-.3ZM25.51,0l-4.9,4.9-1.14-.3-.3-1.14,3.46-3.46H0v9.55h4.54l-1.67,1.67.3,1.14,1.15.3,3.12-3.12h.02l2.59-2.59,1.14.3.3,1.14-.57.57-1.81,1.78.3,1.15,1.15.3,2.5-2.45v8.41l-3.99,3.99.3,1.15,1.15.3,4.62-4.62,1.07.28.3,1.15-1.42,1.42-.93.93-.84.84-1.78,1.78.3,1.15,1.14.3,3.56-3.56.27-.27,1.14.3.3,1.14-4.64,4.64h-.03s-2.52,2.51-2.52,2.51l.31,1.16,1.17.31,2.52-2.52h0s.3-.32.3-.32l1.14.3.3,1.15-3.75,3.75h0s-2.17,2.18-2.17,2.18l.3,1.14,1.15.3,6.35-6.35,1.14.3.3,1.15-2.82,2.77.3,1.14,1.15.3,5.15-5.1v-2.89h0s-1.24,1.24-1.24,1.24l-1.15-.3-.3-1.14,3.43-3.41-.3-1.15-.45-.12-.71-.19-1.05,1.05-1.14-.3-.3-1.14,6.16-6.31-.3-1.15-1.14-.3-1.51,1.51v-4.34l5.25-4.76h7.28V0h-10.92Z"/></g>
            </svg>
        </div>

        <div id="statusMessage" class="status-message"></div>
    </div>

    <input type="file" id="excelFile" accept=".xlsx, .xls, .json" style="display: none;">
    <input type="file" id="imageInput" accept="image/*" style="display: none;">

    <script>
        // ========== VARIABLES GLOBALES ==========
        let colorSequence = [];
        
        const INK_PRESETS = {
            WATER: {
                temp: '320 °F', time: '1:40 min',
                blocker: { name: 'BLOCKER rubber black', mesh1: '122/55', mesh2: '157/48', durometer: '70', strokes: '2', additives: '3 % cross-linker 500 · 1.5 % antitack' },
                white: { name: 'AQUAFLEX WHITE', mesh1: '198/40', mesh2: '157/48', durometer: '70', strokes: '2', additives: '3 % cross-linker 500 · 1.5 % antitack' },
                color: { mesh: '157/48', durometer: '70', strokes: '2', additives: '3 % cross-linker 500 · 1.5 % antitack' }
            },
            PLASTISOL: {
                temp: '320 °F', time: '0:45 min',
                blocker: { name: 'BLOCKER plastisol', mesh1: '110/64', mesh2: '156/64', durometer: '65', strokes: '1', additives: '1 % catalyst' },
                white: { name: 'PLASTISOL WHITE', mesh1: '156/64', mesh2: '110/64', durometer: '65', strokes: '1', additives: '1 % catalyst' },
                color: { mesh: '156/64', durometer: '65', strokes: '1', additives: '1 % catalyst' }
            },
            SILICONE: {
                temp: '320 °F', time: '1:40 min',
                blocker: { name: 'BLOCKER silicone', mesh1: '110/64', mesh2: '157/48', durometer: '70', strokes: '2', additives: '3 % cat · 2 % ret' },
                white: { name: 'WHITE LIBRA', mesh1: '122/55', mesh2: '157/48', durometer: '70', strokes: '2', additives: '3 % cat · 2 % ret' },
                color: { mesh: '157/48', durometer: '70', strokes: '2', additives: '3 % cat · 2 % ret' }
            }
        };

        // ========== NAVEGACIÓN Y UI ==========
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => {
                if (tab.innerText.toLowerCase().includes(tabName.replace('-', ' '))) tab.classList.add('active');
            });
            
            if (tabName === 'saved-specs') loadSavedSpecsList();
            if (tabName === 'dashboard') updateDashboard();
        }

        function showStatus(msg, type = 'success') {
            const el = document.getElementById('statusMessage');
            el.textContent = msg;
            el.className = `status-message status-${type}`;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 4000);
        }
        
        function updateDateTime() {
            const now = new Date();
            document.getElementById('current-datetime').textContent = now.toLocaleDateString('es-ES', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
        }

        function updateDashboard() {
            const total = Object.keys(localStorage).filter(k => k.startsWith('spec_')).length;
            document.getElementById('total-specs').textContent = total;
            // La lógica para specs de hoy requiere más complejidad, se mantiene en 0 por simplicidad
            document.getElementById('today-specs').textContent = 0; 
        }

        // ========== DETECCIÓN DE SPECIALTIES ==========
        function updateSpecialties() {
            const specsField = document.getElementById('specialties');
            // Si el usuario modificó manualmente, no sobrescribir
            if (specsField.dataset.manual === 'true') return; 

            const keywords = ['HD', 'HIGH DENSITY', 'PUFF', 'METALLIC', 'METALICO', 'METÁLICO', 'FOIL', 'GLITTER', 'SHIMMER', 'GEL', 'FLOCK', 'REFLECTIVE', 'SUEDE', 'DISCHARGE'];
            // Permite una palabra clave personalizada (Ej. UN872C) si el cliente es relevante.
            const customKeyword = document.getElementById('customer').value.toUpperCase().includes('UN872C') ? 'UN872C' : null;

            let detected = [];
            
            document.querySelectorAll('[id^="ink-"]').forEach(input => {
                const val = input.value.toUpperCase();
                keywords.forEach(kw => {
                    if (val.includes(kw) && !detected.includes(kw)) {
                        detected.push(kw);
                    }
                });
            });
            
            if (customKeyword && !detected.includes(customKeyword)) {
                 detected.push(customKeyword);
            }


            if (detected.length > 0) {
                specsField.value = detected.join(', ');
            } else {
                specsField.value = '';
            }
        }

        // ========== GESTIÓN DE COLORES (CON LETRA EDITABLE) ==========
        
        function updateScreenLetter(id, value) {
            const item = colorSequence.find(c => c.id == id); // Usar coerción para id
            if (item) {
                item.screenLetter = value;
                updateStations();
            }
        }

        // Función de los botones + Blocker, + White Base, + Color
        function addColorItem(type) {
            // Recoger valores actuales antes de agregar el nuevo elemento
            const currentValues = {};
            document.querySelectorAll('[id^="ink-"]').forEach(input => {
                const id = input.id.split('-')[1];
                const letterInput = document.getElementById(`letter-${id}`);
                currentValues[`ink_${id}`] = input.value;
                if (letterInput) currentValues[`letter_${id}`] = letterInput.value;
            });
        
            let initialLetter = '';
            
            if (type === 'BLOCKER') {
                initialLetter = 'A';
            } else if (type === 'WHITE_BASE') {
                initialLetter = 'B';
            } else if (type === 'COLOR') {
                // Lógica para asignar el siguiente número de color
                let maxColorNum = 0;
                colorSequence.filter(c => c.type !== 'BLOCKER' && c.type !== 'WHITE_BASE').forEach(c => {
                     const letter = c.screenLetter;
                     const num = parseInt(letter);
                     if (!isNaN(num) && num > 0) {
                         maxColorNum = Math.max(maxColorNum, num);
                     }
                });
                initialLetter = String(maxColorNum + 1);
            }
            
            colorSequence.push({ id: Date.now(), type, screenLetter: initialLetter });
            renderColors(currentValues);
            updateStations();
            applyInkPreset(); 
        }

        function removeColorItem(id) {
            const currentValues = {};
            document.querySelectorAll('[id^="ink-"]').forEach(input => {
                const currentId = input.id.split('-')[1];
                if(currentId != id) {
                    const letterInput = document.getElementById(`letter-${currentId}`);
                    currentValues[`ink_${currentId}`] = input.value;
                    if (letterInput) currentValues[`letter_${currentId}`] = letterInput.value;
                }
            });
            
            colorSequence = colorSequence.filter(i => i.id !== id);
            renderColors(currentValues);
            updateStations();
            updateSpecialties();
        }

        function renderColors(savedValues = {}) {
            const container = document.getElementById('colors-container');
            container.innerHTML = '';
            
            colorSequence.forEach((item) => {
                const badgeClass = item.type === 'BLOCKER' ? 'badge-blocker' : item.type === 'WHITE_BASE' ? 'badge-white' : 'badge-color';
                const label = item.type === 'BLOCKER' ? 'BLOQUEADOR' : item.type === 'WHITE_BASE' ? 'WHITE BASE' : 'COLOR';
                
                const div = document.createElement('div');
                div.className = 'color-item';
                
                // Usar el valor guardado en savedValues o el de item.screenLetter
                const screenLetterValue = savedValues[`letter_${item.id}`] || item.screenLetter || '';

                div.innerHTML = `
                    <span class="badge ${badgeClass}">${label}</span>
                    <input type="text" style="width: 50px; text-align: center; font-weight: bold;" 
                           value="${screenLetterValue}" 
                           id="letter-${item.id}"
                           oninput="updateScreenLetter(${item.id}, this.value.toUpperCase())"
                           class="form-control" title="Letra/Número de Pantalla">

                    <input type="text" class="form-control" id="ink-${item.id}" placeholder="Nombre de la tinta..." onchange="updateStations(); updateSpecialties();">
                    <button class="btn btn-danger btn-sm" onclick="removeColorItem(${item.id})"><i class="fas fa-times"></i></button>
                `;
                container.appendChild(div);
                
                if (savedValues[`ink_${item.id}`] !== undefined) {
                    document.getElementById(`ink-${item.id}`).value = savedValues[`ink_${item.id}`];
                }

                // Asegurar que el valor del screenLetter esté actualizado en el objeto global
                item.screenLetter = screenLetterValue;
            });
            updateSpecialties(); 
        }

        // ========== TABLA DE IMPRESIÓN (MODIFICADA) ==========
        function updateStations(returnOnly = false) {
            const type = document.getElementById('ink-type-select').value;
            const preset = INK_PRESETS[type];
            const stationsData = [];
            let stNum = 1;

            colorSequence.forEach((item, idx) => {
                const inkVal = document.getElementById(`ink-${item.id}`)?.value || '---';
                let mesh, strokes, duro, add, screenLetter, screenTypeLabel;

                // USAMOS LA LETRA/NÚMERO EDITABLE
                screenLetter = item.screenLetter.trim() || 'N/A'; 

                if (item.type === 'BLOCKER') {
                    screenTypeLabel = preset.blocker.name;
                    mesh = stNum <= 3 ? preset.blocker.mesh1 : preset.blocker.mesh2;
                    strokes = preset.blocker.strokes; duro = preset.blocker.durometer; add = preset.blocker.additives;
                } else if (item.type === 'WHITE_BASE') {
                    screenTypeLabel = preset.white.name;
                    mesh = stNum <= 9 ? preset.white.mesh1 : preset.white.mesh2;
                    strokes = preset.white.strokes; duro = preset.white.durometer; add = preset.white.additives;
                } else {
                    screenTypeLabel = inkVal;
                    mesh = preset.color.mesh;
                    strokes = preset.color.strokes; duro = preset.color.durometer; add = preset.color.additives;
                }
                
                // Columna Screen combinada: si es Blocker o Base, usamos el nombre del preset, si es Color, el nombre de la tinta.
                const screenCombined = (item.type === 'BLOCKER' || item.type === 'WHITE_BASE') 
                               ? screenTypeLabel
                               : inkVal;
                
                stationsData.push({ 
                    st: stNum++, 
                    screenLetter: screenLetter,
                    screenCombined: screenCombined,
                    mesh: mesh, 
                    ink: inkVal,
                    strokes: strokes, 
                    duro: duro, 
                    add: add 
                });

                if (idx < colorSequence.length - 1) {
                    // FLASH station
                    stationsData.push({ st: stNum++, screenLetter: '', screenCombined: 'FLASH', mesh: '-', ink: '-', strokes: '-', duro: '-', add: '' });
                    // COOL station
                    stationsData.push({ st: stNum++, screenLetter: '', screenCombined: 'COOL', mesh: '-', ink: '-', strokes: '-', duro: '-', add: '' });
                }
            });
            
            if (returnOnly) return stationsData;
            
            renderStationsTable(stationsData);
        }

        function renderStationsTable(data) {
            const div = document.getElementById('print-sequence-table');
            if (data.length === 0) {
                div.innerHTML = '<p style="color:#718096; font-style:italic; text-align:center; padding:20px;">Agrega colores arriba para ver la secuencia.</p>';
                return;
            }
            
            let html = `<table class="sequence-table">
                <thead><tr>
                    <th>Est</th>
                    <th>Screen Letter / Pantalla</th>
                    <th>Screen (Tinta/Proceso)</th>
                    <th>Aditivos</th>
                    <th>Malla</th>
                    <th>Golpes</th>
                    <th>Duro</th>
                </tr></thead><tbody>`;
            
            data.forEach(row => {
                html += `<tr>
                    <td>${row.st}</td>
                    <td><b>${row.screenLetter}</b></td>
                    <td>${row.screenCombined}</td>
                    <td style="font-size:11px; color:var(--tegra-green); font-weight:600;">${row.add}</td>
                    <td>${row.mesh}</td>
                    <td>${row.strokes}</td>
                    <td>${row.duro}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            div.innerHTML = html;
        }

        function applyInkPreset() {
            const type = document.getElementById('ink-type-select').value;
            const preset = INK_PRESETS[type];
            document.getElementById('ink-type').value = type === 'WATER' ? 'AQUAFLEX MAGNA' : type;
            document.getElementById('temp').value = preset.temp;
            document.getElementById('time').value = preset.time;
            
            // Llenar inputs de tinta si están vacíos
            colorSequence.forEach(item => {
                const input = document.getElementById(`ink-${item.id}`);
                if (input && !input.value) {
                    if (item.type === 'BLOCKER') input.value = preset.blocker.name;
                    if (item.type === 'WHITE_BASE') input.value = preset.white.name;
                }
            });
            updateStations();
        }

        // ========== LOGOS CLIENTES ==========
        function updateClientLogo() {
            const val = document.getElementById('customer').value.toLowerCase();
            const container = document.getElementById('logoCliente');
            container.innerHTML = ''; 
            
            if (val.includes('nike')) {
                container.innerHTML = `<path fill="#fff" d="M27.16,19.5c-5.94,1.63-10.72,1.46-13.46-.54-7.02-5.12-1.79-15.56.11-18.67-3.4,3.82-6.78,7.64-9.41,11.81C.29,18.63-1.45,25.75,1.4,30.3c5.13,8.19,17.26,4.31,24.97.95L98.07,0,27.16,19.5Z"/>`;
            } else if (val.includes('fanatics')) {
                container.innerHTML = `<path fill="#fff" d="M60.38,11.14c-1.16,0-2.14.39-3.13,1.25v-.96c0-.08-.07-.15-.15-.15h-2.55c-.08,0-.15.07-.15.15v10.73c0,.08.07.15.15.15h2.64c.08,0,.15-.07.15-.15v-5.85c0-1.3,1.07-2.42,2.33-2.44h.05c1.65,0,2.24,1.3,2.24,2.51v5.78c0,.08.07.15.15.15h2.66c.08,0,.15-.07.15-.15v-5.8c0-3.12-1.82-5.22-4.54-5.22Z"/>
                    <path fill="#fff" d="M52.66,11.26h-2.63c-.08,0-.15.07-.15.15v.46c-.89-.7-1.98-.81-3.03-.81h-.05c-3.33,0-5.48,2.18-5.48,5.55,0,1.75.53,3.21,1.54,4.2.96.94,2.3,1.44,3.88,1.44h.16c.97-.02,2.05-.04,2.97-.89v.81c0,.08.07.15.15.15h2.63c.08,0,.15-.07.15-.15v-10.75c0-.08-.07-.15-.15-.15ZM49.3,18.55c-.5.58-1.38.94-2.23.94-1.67,0-2.8-1.16-2.8-2.88s1.12-2.86,2.8-2.86c2.03,0,2.87,1.44,2.87,2.83,0,.76-.2,1.46-.64,1.98Z"/>`;
            }
        }

        // ========== IMAGEN PREVIEW ==========
        document.getElementById('imageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(ev) {
                const img = document.getElementById('imagePreview');
                img.src = ev.target.result;
                img.style.display = 'block';
            };
            reader.readAsDataURL(file);
        });

        // ========== CARGA EXCEL / JSON ==========
        document.getElementById('excelFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            if (file.name.toLowerCase().endsWith('.json')) {
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        loadSpecData(data);
                        showStatus('✅ JSON Cargado correctamente', 'success');
                    } catch (err) {
                        console.error('Error al cargar JSON:', err);
                        showStatus('❌ Error leyendo JSON', 'error');
                    }
                };
                reader.readAsText(file);
            } else { // Asume Excel (.xlsx, .xls)
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        const sheetPriority = ['Proto 1', 'Proto 2', 'Proto 3', 'Proto 4', 'Sheet1'];
                        let worksheet = null;
                        let sheetUsed = '';
                        
                        for (const sheetName of sheetPriority) {
                            if (workbook.SheetNames.includes(sheetName)) {
                                worksheet = workbook.Sheets[sheetName];
                                sheetUsed = sheetName;
                                break;
                            }
                        }
                        if (!worksheet) {
                            worksheet = workbook.Sheets[workbook.SheetNames[0]];
                            sheetUsed = workbook.SheetNames[0];
                        }

                        showStatus(`Leído: ${sheetUsed}`, 'success');
                        processExcelData(worksheet);
                        
                    } catch (err) { console.error('Error al cargar Excel:', err); showStatus('❌ Error leyendo Excel', 'error'); }
                };
                reader.readAsArrayBuffer(file);
            }
        });

        function processExcelData(worksheet) {
            const data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            const extracted = {};

            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length < 3) continue;
                
                const label = String(row[1] || '').trim();
                const val = String(row[2] || '').trim();

                if (label.includes('CUSTOMER:')) extracted.customer = val;
                else if (label.includes('STYLE:')) {
                    extracted.style = val.split('\n')[0]; 
                    const styleUpper = val.toUpperCase();
                    const teamMatch = styleUpper.match(/\s([A-Z]{3})\s/);
                    if (teamMatch) extracted.team = teamMatch[1];
                    const genderMatch = styleUpper.match(/\s(M|W)\s/);
                    if (genderMatch) extracted.gender = genderMatch[1] === 'M' ? 'MALE' : 'FEMALE';
                }
                else if (label.includes('COLORWAY')) extracted.colorway = val;
                else if (label.includes('SEASON:')) extracted.season = val;
                else if (label.includes('PATTERN')) extracted.pattern = val;
                else if (label.includes('P.O.')) extracted.po = val;
                else if (label.includes('SAMPLE TYPE') || label.includes('SAMPLE:')) extracted.sample = val;
                else if (label.includes('FOLDER')) extracted.folder = val;
            }

            if (extracted.customer) document.getElementById('customer').value = extracted.customer;
            if (extracted.style) document.getElementById('style').value = extracted.style;
            if (extracted.folder) document.getElementById('folder-num').value = extracted.folder; 
            if (extracted.colorway) document.getElementById('colorway').value = extracted.colorway;
            if (extracted.season) document.getElementById('season').value = extracted.season;
            if (extracted.pattern) document.getElementById('pattern').value = extracted.pattern;
            if (extracted.po) document.getElementById('po').value = extracted.po;
            if (extracted.sample) document.getElementById('sample-type').value = extracted.sample;
            if (extracted.team) document.getElementById('name-team').value = extracted.team;
            if (extracted.gender) document.getElementById('gender').value = extracted.gender;

            updateClientLogo();
            if (Object.keys(extracted).length > 0) showStatus('✅ Datos extraídos correctamente', 'success');
        }

        // ========== FUNCIÓN: DESCARGAR JSON (ACTIVA) ==========
        function downloadJSON() {
            try {
                saveSpec(); 
                
                const style = document.getElementById('style').value || 'SinEstilo';
                const data = collectData();
                
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `TegraSpec_${style}_${Date.now()}.json`);
                document.body.appendChild(downloadAnchorNode); 
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
                
                showStatus('⬇️ JSON Descargado', 'success');
            } catch (error) {
                console.error('Error al descargar JSON:', error);
                showStatus('❌ Error al descargar JSON', 'error');
            }
        }

        function collectData() {
             const imageSrc = document.getElementById('imagePreview').src;
             // Asegurar que el colorSequence tenga los últimos valores
             colorSequence.forEach(item => {
                 item.screenLetter = document.getElementById(`letter-${item.id}`)?.value || item.screenLetter;
             });

             return {
                customer: document.getElementById('customer').value,
                style: document.getElementById('style').value,
                folder: document.getElementById('folder-num').value,
                colorway: document.getElementById('colorway').value,
                season: document.getElementById('season').value,
                pattern: document.getElementById('pattern').value,
                po: document.getElementById('po').value,
                sampleType: document.getElementById('sample-type').value,
                nameTeam: document.getElementById('name-team').value,
                gender: document.getElementById('gender').value,
                designer: document.getElementById('designer').value,
                colors: colorSequence.map(c => ({ 
                    id: c.id, 
                    type: c.type, 
                    val: document.getElementById(`ink-${c.id}`)?.value || '', 
                    screenLetter: c.screenLetter 
                })),
                inkType: document.getElementById('ink-type-select').value,
                dimensions: document.getElementById('dimensions').value,
                placementType: document.getElementById('placement-select').value,
                placement: document.getElementById('placement').value,
                specialties: document.getElementById('specialties').value,
                instructions: document.getElementById('special-instructions').value,
                imageB64: (imageSrc && imageSrc.startsWith('data:')) ? imageSrc : null, 
                savedAt: new Date().toISOString()
            };
        }

        // ========== GUARDAR/CARGAR STORAGE ==========
        function saveSpec() {
            const style = document.getElementById('style').value || 'SinEstilo';
            const data = collectData();
            localStorage.setItem(`spec_${style}_${Date.now()}`, JSON.stringify(data));
            updateDashboard();
        }

        function loadSavedSpecsList() {
            const list = document.getElementById('saved-specs-list');
            list.innerHTML = '';
            Object.keys(localStorage).forEach(key => {
                if (!key.startsWith('spec_')) return;
                try {
                    const data = JSON.parse(localStorage.getItem(key));
                    const div = document.createElement('div');
                    div.style.cssText = "padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;";
                    div.innerHTML = `
                        <div><strong>${data.style || 'N/A'}</strong> <span style="color:#718096">(${data.customer || 'N/A'})</span></div>
                        <div>
                            <button class="btn btn-primary btn-sm" onclick='loadSpecData(${JSON.stringify(data)})'>Cargar</button>
                            <button class="btn btn-danger btn-sm" onclick="localStorage.removeItem('${key}'); loadSavedSpecsList(); updateDashboard();"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    list.appendChild(div);
                } catch (e) {
                    // Ignorar o limpiar entrada corrupta
                    console.error('Error al parsear spec guardada:', key, e);
                }
            });
        }

        function loadSpecData(data) {
            document.getElementById('customer').value = data.customer || '';
            document.getElementById('style').value = data.style || '';
            document.getElementById('folder-num').value = data.folder || ''; 
            document.getElementById('colorway').value = data.colorway || '';
            document.getElementById('season').value = data.season || '';
            document.getElementById('pattern').value = data.pattern || '';
            document.getElementById('po').value = data.po || '';
            document.getElementById('sample-type').value = data.sampleType || '';
            document.getElementById('name-team').value = data.nameTeam || '';
            document.getElementById('gender').value = data.gender || '';
            document.getElementById('designer').value = data.designer || '';
            document.getElementById('ink-type-select').value = data.inkType || 'WATER';
            document.getElementById('dimensions').value = data.dimensions || '';
            document.getElementById('placement-select').value = data.placementType || 'FRONT';
            document.getElementById('placement').value = data.placement || '';
            document.getElementById('specialties').value = data.specialties || '';
            document.getElementById('special-instructions').value = data.instructions || '';
            
            if (data.imageB64) {
                const img = document.getElementById('imagePreview');
                img.src = data.imageB64;
                img.style.display = 'block';
            } else {
                document.getElementById('imagePreview').style.display = 'none';
                document.getElementById('imagePreview').src = '';
            }

            colorSequence = []; 
            const values = {};
            // Asegurar compatibilidad si se cargan datos sin screenLetter
            data.colors.forEach(c => {
                colorSequence.push({ id: c.id, type: c.type, screenLetter: c.screenLetter || '' }); 
                values[`ink_${c.id}`] = c.val;
                values[`letter_${c.id}`] = c.screenLetter || '';
            });
            
            renderColors(values);
            applyInkPreset();
            updateClientLogo();
            showTab('spec-creator');
            showStatus('📂 Spec cargada correctamente');
        }

        function clearForm() {
            if(confirm('¿Limpiar todo el formulario?')) {
                // Excluir folder-num de la limpieza masiva
                document.querySelectorAll('input:not(#folder-num), textarea').forEach(i => i.value = '');
                document.getElementById('designer').value = '';
                // No limpiar folder-num para mantener el contexto
                document.getElementById('imagePreview').style.display = 'none';
                document.getElementById('imagePreview').src = '';
                colorSequence = []; renderColors(); updateStations();
                showStatus('Formulario limpio');
            }
        }

        // ========== GENERACIÓN PDF (ACTIVA) ==========
        function exportPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageW = pdf.internal.pageSize.getWidth();
                let y = 15;
                
                const navyColor = [0, 40, 85];
                const greenColor = [120, 190, 32];
                
                const text = (str, x, yVal, size=10, bold=false, color=[0, 0, 0]) => {
                    pdf.setTextColor(...color); 
                    pdf.setFontSize(size);
                    pdf.setFont('helvetica', bold ? 'bold' : 'normal');
                    pdf.text(String(str), x, yVal);
                };

                // === 1. Header con Logo TEGRA y FOLDER ===
                pdf.setFillColor(...navyColor);
                pdf.rect(0, 0, pageW, 25, 'F');
                
                // Logo TEGRA (En blanco para el fondo azul)
                const tegraLogoSVG = "data:image/svg+xml;base64," + btoa(`
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 145.94 39.05" width="145.94" height="39.05">
                        <path fill="#ffffff" d="M42.24,12.37v1.93h6.91v15.25h4.21v-15.25h6.91v-3.88h-16.1l-1.93,1.95ZM92.06,20.31v1.87h4.24v2.73c-.53.38-1.13.67-1.8.86-.67.19-1.39.29-2.16.29-.84,0-1.61.15-2.32-.45-.71-.3-1.33-.72-1.84-1.27-.52-.55-.92-1.19-1.2-1.93-.28-.74-.42-1.54-.42-2.42v-.05c0-.82.14-1.59.42-2.31.28-.72.67-1.35,1.18-1.89.5-.54,1.08-.97,1.75-1.28.66-.32,1.38-.48,2.15-.48.55,0,1.05.05,1.5.14.46.09.88.22,1.27.38.39.16.77.36,1.13.6.25.16.49.34.74.54l2.94-2.97c-.47-.4-.96-.75-1.46-1.07-.53-.33-1.09-.6-1.7-.82-.6-.22-1.25-.39-1.95-.51-.7-.12-1.48-.18-2.34-.18-1.44,0-2.77.26-4,.78-1.23.52-2.29,1.23-3.18,2.13-.89.9-1.59,1.95-2.09,3.14-.50,1.19-.75,2.47-.75,3.84v.05c0,1.42.25,2.73.74,3.94.49,1.2,1.18,2.24,2.06,3.12.88.87,1.94,1.56,3.17,2.05,1.23.49,2.59.74,4.09.74,1.75,0,3.3-.3,4.66-.89,1.36-.59,2.53-1.31,3.51-2.15v-8.31h-6.56l-1.74,1.76ZM68.15,21.8h9.02v-3.74h-9.02v-3.88h10.25v-3.74h-12.55l-1.86,1.88v17.26h14.54v-3.74h-10.39v-4.02ZM114.24,10.43h-8.75v19.13h4.21v-6.12h3.31l4.1,6.12h2.57l1.39-1.4-3.71-5.43c1.22-.46,2.21-1.17,2.97-2.15.76-.97,1.13-2.24,1.13-3.79v-.05c0-1.82-.55-3.28-1.64-4.37-1.29-1.29-3.15-1.94-5.58-1.94ZM117.19,17.03c0,.82-.28,1.48-.83,1.98-.56.49-1.35.74-2.39.74h-4.26v-5.52h4.18c1.04,0,1.85.23,2.43.69.58.46.87,1.14.87,2.06v.05ZM136.7,10.29h-3.88l-8.2,19.27h4.29l1.75-4.29h8.09l1.75,4.29h1.97l1.7-1.72-7.47-17.55ZM132.16,21.58l2.54-6.2,2.54,6.2h-5.08Z"/>
                        <g><polygon fill="#ffffff" points="7.44 31.38 6.59 32.24 6.88 33.39 8.03 33.68 8.89 32.83 8.59 31.68 7.44 31.38"/><polygon fill="#ffffff" points="6.79 28.67 7.94 28.97 10.41 26.5 10.11 25.35 8.96 25.05 6.49 27.52 6.79 28.67"/><polygon fill="#ffffff" points="10.54 14.61 9.4 14.31 6.93 16.78 7.23 17.93 8.37 18.23 10.85 15.76 10.54 14.61"/><polygon fill="#ffffff" points="26.38 22.79 25.06 24.11 25.36 25.26 26.5 25.56 27.82 24.24 27.52 23.09 26.38 22.79"/><path fill="#ffffff" d="M21.9,36.93l.3,1.15,1.15.3.85-.85-.3-1.15-1.15-.3-.85.85ZM18.01,29.21l-.3-1.15.85-.85,1.15.3.3,1.15-.85.85-1.15-.3ZM18.83,19.56l-.3-1.15,1.5-1.5,1.15.3.3,1.15-1.5,1.5-1.15-.3ZM20.85,14.61l-.3-1.15,1.5-1.5,1.15.3.3,1.15-1.5,1.5-1.15-.3ZM14.33,15.34l-.3-1.14,3.78-3.68,1.14.3.3,1.14-3.78,3.68-1.15-.3ZM24.21,10.68l-.3-1.15,2.17-2.17,1.14.3.3,1.14-2.17,2.17-1.14-.3ZM20.59,9.12l-.3-1.15.85-.85,1.15.3.3,1.15-.85.85-1.15-.3ZM15.06,8.82l-.3-1.15,1.5-1.5,1.15.3.3,1.15-1.5,1.5-1.15-.3ZM25.51,0l-4.9,4.9-1.14-.3-.3-1.14,3.46-3.46H0v9.55h4.54l-1.67,1.67.3,1.14,1.15.3,3.12-3.12h.02l2.59-2.59,1.14.3.3,1.14-.57.57-1.81,1.78.3,1.15,1.15.3,2.5-2.45v8.41l-3.99,3.99.3,1.15,1.15.3,4.62-4.62,1.07.28.3,1.15-1.42,1.42-.93.93-.84.84-1.78,1.78.3,1.15,1.14.3,3.56-3.56.27-.27,1.14.3.3,1.14-4.64,4.64h-.03s-2.52,2.51-2.52,2.51l.31,1.16,1.17.31,2.52-2.52h0s.3-.32.3-.32l1.14.3.3,1.15-3.75,3.75h0s-2.17,2.18-2.17,2.18l.3,1.14,1.15.3,6.35-6.35,1.14.3.3,1.15-2.82,2.77.3,1.14,1.15.3,5.15-5.1v-2.89h0s-1.24,1.24-1.24,1.24l-1.15-.3-.3-1.14,3.43-3.41-.3-1.15-.45-.12-.71-.19-1.05,1.05-1.14-.3-.3-1.14,6.16-6.31-.3-1.15-1.14-.3-1.51,1.51v-4.34l5.25-4.76h7.28V0h-10.92Z"/></g>
                    </svg>
                `);
                
                pdf.addImage(tegraLogoSVG, 'SVG', 15, 6, 35, 10);
                
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(14); pdf.setFont('helvetica', 'bold');
                pdf.text('TECHNICAL SPEC MANAGER', 55, 12);
                pdf.setFontSize(10); pdf.setFont('helvetica', 'normal');
                pdf.text('Sistema de gestión de especificaciones técnicas', 55, 17);
                
                // FOLDER # en Header
                const folderNum = document.getElementById('folder-num').value || '#####';
                pdf.setFontSize(10); pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(...greenColor); // tegra-green
                pdf.text('# FOLDER:', pageW - 40, 12);
                pdf.setTextColor(255, 255, 255);
                pdf.text(folderNum, pageW - 20, 12, { align: 'right' });


                // Info Grid
                y = 35;
                const fields = [
                    { l: 'CLIENTE:', v: document.getElementById('customer').value },
                    { l: 'STYLE:', v: document.getElementById('style').value },
                    { l: 'COLORWAY:', v: document.getElementById('colorway').value },
                    { l: 'SEASON:', v: document.getElementById('season').value },
                    { l: 'PO #:', v: document.getElementById('po').value },
                    { l: 'SAMPLE:', v: document.getElementById('sample-type').value },
                    { l: 'TEAM:', v: document.getElementById('name-team').value },
                    { l: 'DESIGNER:', v: document.getElementById('designer').value },
                    { l: 'GENDER:', v: document.getElementById('gender').value },
                ];

                text('INFORMACIÓN GENERAL', 15, y, 12, true);
                y += 8;
                
                fields.forEach((f, i) => {
                    const xPos = i % 2 === 0 ? 15 : 110;
                    text(f.l, xPos, y, 9, true);
                    text(f.v || '---', xPos + 30, y, 9, false);
                    if (i % 2 !== 0) y += 6;
                });
                y += 10;

                // Imagen e Info de Impresión
                const img = document.getElementById('imagePreview');
                if (img.src && img.style.display !== 'none') {
                    try {
                        const imgH = 60;
                        pdf.addImage(img.src, 'JPEG', 15, y, 60, imgH);
                        let yInk = y;
                        text('CONDICIONES DE IMPRESIÓN', 80, yInk, 11, true);
                        yInk += 6;
                        text('Temp: ' + document.getElementById('temp').value, 80, yInk); yInk += 5;
                        text('Time: ' + document.getElementById('time').value, 80, yInk); yInk += 5;
                        text('Type: ' + document.getElementById('ink-type').value, 80, yInk); yInk += 5;
                        text('Dims: ' + document.getElementById('dimensions').value, 80, yInk); yInk += 5;
                        text('Loc: ' + document.getElementById('placement-select').value, 80, yInk); yInk += 5;
                        text('Plcmt: ' + document.getElementById('placement').value, 80, yInk); yInk += 5;
                        text('Specialties: ' + document.getElementById('specialties').value, 80, yInk);
                        
                        y += imgH + 10;
                    } catch (e) { y += 10; }
                } else {
                    y += 10;
                }

                // Tabla Secuencia
                if (y > 220) { pdf.addPage(); y = 20; }
                text('SECUENCIA DE IMPRESIÓN', 15, y, 12, true);
                y += 8;

                const pdfHeaders = ['Est', 'Scr. Ltr', 'Screen (Tinta/Proceso)', 'Aditivos', 'Malla', 'Golpes', 'Duro'];
                const pdfColW = [8, 15, 65, 40, 15, 12, 12];
                let x = 15;
                
                pdf.setFillColor(...navyColor); 
                pdf.rect(15, y - 5, 180, 8, 'F'); 
                pdf.setTextColor(255, 255, 255); 
                pdf.setFontSize(8);
                pdf.setFont('helvetica', 'bold');
                
                pdfHeaders.forEach((h, i) => {
                    pdf.text(h, x + 2, y);
                    x += pdfColW[i];
                });
                y += 6;

                pdf.setTextColor(0, 0, 0); 
                pdf.setFont('helvetica', 'normal');
                pdf.setFontSize(8);

                const tableData = updateStations(true); 
                
                tableData.forEach((row, idx) => {
                    if (y > 270) { pdf.addPage(); y = 20; }
                    
                    if (idx % 2 === 0) {
                        pdf.setFillColor(245, 245, 245);
                        pdf.rect(15, y - 4, 180, 6, 'F');
                    }
                    x = 15;
                    const data = [
                        row.st, row.screenLetter, row.screenCombined, 
                        row.add, row.mesh, row.strokes, row.duro
                    ];
                    const columnMaxLengths = [5, 10, 40, 30, 15, 10, 10]; 

                    data.forEach((d, i) => {
                        let safeText = String(d);
                        if (safeText.length > columnMaxLengths[i]) safeText = safeText.substring(0, columnMaxLengths[i]);
                        
                        if (i === 1) pdf.setFont('helvetica', 'bold'); 
                        if (i === 3) pdf.setTextColor(...greenColor); 

                        pdf.text(safeText, x + 2, y);
                        x += pdfColW[i];
                        
                        if (i === 1) pdf.setFont('helvetica', 'normal'); 
                        if (i === 3) pdf.setTextColor(0, 0, 0); 
                    });
                    y += 6;
                });

                y += 5;
                const inst = document.getElementById('special-instructions').value;
                if (inst) {
                    pdf.setDrawColor(200);
                    pdf.rect(15, y, 180, 20);
                    text('INSTRUCCIONES ESPECIALES:', 17, y + 5, 9, true);
                    const splitText = pdf.splitTextToSize(inst, 170); 
                    pdf.text(splitText, 17, y + 10);
                    y += 20;
                }

                pdf.setFontSize(8);
                pdf.setTextColor(150);
                pdf.text('Generado por Tegra Spec Manager', pageW / 2, 290, { align: 'center' });

                pdf.save(`Spec_${document.getElementById('style').value || 'Tegra'}.pdf`);
                showStatus('✅ PDF Generado con éxito');
            } catch (error) {
                console.error('Error al generar PDF:', error);
                showStatus('❌ Error al generar PDF', 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
             updateDateTime();
             updateDashboard();
             applyInkPreset();
             loadSavedSpecsList();
        });
    </script>
</body>
</html>