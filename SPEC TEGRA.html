<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tegra - Technical Spec Manager</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            /* === NUEVA PALETA DE COLORES ROJO Y GRIS === */
            --primary-red: #D32F2F;
            --primary-red-dark: #B71C1C;
            --primary-red-light: #EF5350;
            --accent-red: #FF5252;
            
            --gray-dark: #263238;
            --gray-medium: #546E7A;
            --gray-light: #78909C;
            --gray-extra-light: #ECEFF1;
            --gray-bg: #FAFAFA;
            
            --success: #4CAF50;
            --warning: #FF9800;
            --error: #F44336;
            --info: #2196F3;
            
            /* Variables de aplicación */
            --primary: var(--primary-red);
            --primary-dark: var(--primary-red-dark);
            --primary-light: var(--primary-red-light);
            --accent: var(--accent-red);
            --secondary: var(--gray-extra-light);
            --text-dark: var(--gray-dark);
            --text-light: var(--gray-medium);
            --border: #CFD8DC;
            --shadow: 0 4px 12px rgba(38, 50, 56, 0.1);
            --shadow-lg: 0 8px 24px rgba(38, 50, 56, 0.15);
            --radius: 8px;
            --radius-lg: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            font-family: 'Segoe UI', 'Roboto', Tahoma, Geneva, Verdana, sans-serif; 
        }
        
        body {
            background: linear-gradient(135deg, var(--gray-bg) 0%, #f0f2f5 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-dark);
            line-height: 1.6;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            border-top: 5px solid var(--accent);
            position: relative;
        }

        /* Header Moderno */
        .app-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            position: relative;
            overflow: hidden;
        }

        .app-header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 150px;
            height: 150px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(30%, -30%);
        }

        .logo-section { 
            display: flex; 
            align-items: center; 
            gap: 25px; 
            position: relative;
            z-index: 1;
        }
        
        .app-logo svg { 
            height: 45px; 
            width: auto; 
            fill: white; 
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }
        
        .app-title { 
            font-size: 1.6rem; 
            font-weight: 700; 
            letter-spacing: 0.5px; 
            margin-bottom: 4px;
        }
        
        .app-subtitle { 
            font-size: 0.85rem; 
            opacity: 0.9; 
            letter-spacing: 0.5px; 
            font-weight: 400;
        }
        
        .client-section {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 18px;
            border-radius: var(--radius);
            margin-left: 20px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .client-label {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            color: white;
            letter-spacing: 0.5px;
        }

        .client-logo-wrapper {
            height: 35px;
            display: flex;
            align-items: center;
        }
        
        .client-logo-wrapper svg {
            fill: white; 
            max-height: 100%;
            width: auto;
        }
        
        /* Header Actions */
        .header-actions {
            display: flex; 
            flex-direction: column; 
            align-items: flex-end; 
            gap: 8px;
            position: relative;
            z-index: 1;
        }

        .folder-input-container {
            display: flex; 
            align-items: center; 
            gap: 8px;
            background: rgba(255, 255, 255, 0.15);
            padding: 6px 12px;
            border-radius: var(--radius);
            backdrop-filter: blur(5px);
        }

        .header-actions .form-control {
            width: 150px;
            padding: 6px 10px; 
            font-size: 13px;
            text-align: right;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: bold;
            border-radius: 4px;
            transition: var(--transition);
        }
        
        .header-actions .form-control::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .header-actions .form-control:focus {
             background: white;
             color: var(--text-dark);
             box-shadow: 0 0 0 2px var(--accent);
        }

        #current-datetime {
            font-size: 0.9rem;
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* Navigation Moderna */
        .app-nav { 
            background: white; 
            padding: 0 30px; 
            border-bottom: 1px solid var(--border);
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }
        
        .nav-tabs { 
            display: flex; 
            list-style: none; 
            gap: 0; 
        }
        
        .nav-tab {
            padding: 18px 24px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: var(--text-light);
            transition: var(--transition);
            font-size: 0.95rem;
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-tab:hover { 
            color: var(--primary); 
            background: var(--gray-extra-light);
        }
        
        .nav-tab.active { 
            color: var(--primary); 
            border-bottom-color: var(--accent); 
            background: var(--gray-extra-light);
        }
        
        .nav-tab.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 3px;
            height: 100%;
            background: var(--accent);
        }

        /* Content */
        .app-main { 
            padding: 30px; 
            min-height: 600px; 
            background: var(--gray-bg);
        }
        
        .tab-content { 
            display: none; 
            animation: fadeIn 0.4s ease; 
        }
        
        .tab-content.active { 
            display: block; 
        }
        
        @keyframes fadeIn { 
            from { 
                opacity: 0; 
                transform: translateY(10px); 
            } 
            to { 
                opacity: 1; 
                transform: translateY(0); 
            } 
        }

        /* Cards Modernas */
        .card {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            border: 1px solid var(--border);
            overflow: hidden;
            transition: var(--transition);
        }
        
        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        
        .card-header {
            background: linear-gradient(to right, var(--gray-extra-light), white);
            padding: 18px 25px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-title { 
            font-size: 1.1rem; 
            font-weight: 700; 
            color: var(--primary); 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
        }
        
        .card-body { 
            padding: 25px; 
        }

        /* Forms Modernos */
        .form-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 20px; 
        }
        
        .form-group { 
            margin-bottom: 20px; 
            position: relative;
        }
        
        .form-label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 700; 
            font-size: 0.85rem; 
            color: var(--text-dark); 
            text-transform: uppercase; 
            letter-spacing: 0.5px;
        }
        
        .form-control {
            width: 100%; 
            padding: 12px 15px;
            border: 1px solid var(--border); 
            border-radius: var(--radius);
            font-size: 14px; 
            transition: var(--transition);
            background: white;
        }
        
        .form-control:focus { 
            outline: none; 
            border-color: var(--primary); 
            box-shadow: 0 0 0 3px rgba(211, 47, 47, 0.1); 
        }

        /* Buttons Modernos */
        .btn {
            padding: 12px 24px; 
            border: none; 
            border-radius: var(--radius);
            font-weight: 600; 
            cursor: pointer; 
            transition: var(--transition);
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 14px;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        .btn:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }
        
        .btn:active { 
            transform: translateY(1px); 
        }
        
        .btn-primary { 
            background: var(--primary); 
            box-shadow: 0 2px 5px rgba(211, 47, 47, 0.3);
        }
        
        .btn-primary:hover { 
            background: var(--primary-dark); 
            box-shadow: 0 4px 8px rgba(211, 47, 47, 0.4);
        }
        
        .btn-white-base { 
            background: #ffffff; 
            color: var(--text-dark); 
            border: 1px solid var(--border); 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .btn-white-base:hover { 
            background: #f5f5f5; 
            border-color: var(--gray-light); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .btn-success { 
            background: var(--success); 
            box-shadow: 0 2px 5px rgba(76, 175, 80, 0.3);
        }
        
        .btn-success:hover { 
            background: #43A047; 
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.4);
        }
        
        .btn-warning { 
            background: var(--warning); 
            box-shadow: 0 2px 5px rgba(255, 152, 0, 0.3);
        }
        
        .btn-danger { 
            background: var(--error); 
            box-shadow: 0 2px 5px rgba(244, 67, 54, 0.3);
        }
        
        .btn-outline { 
            background: transparent; 
            border: 1px solid var(--border); 
            color: var(--text-light); 
        }
        
        .btn-outline:hover { 
            border-color: var(--primary); 
            color: var(--primary); 
            background: rgba(211, 47, 47, 0.05);
        }
        
        .btn-sm { 
            padding: 8px 16px; 
            font-size: 12px; 
        }
        
        .btn-lg { 
            padding: 16px 32px; 
            font-size: 16px; 
        }

        /* Sequences & Tables Modernos */
        .sequence-table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 13px; 
            margin-top: 10px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-radius: var(--radius);
            overflow: hidden;
        }
        
        .sequence-table th { 
            background: linear-gradient(to right, var(--primary), var(--primary-dark)); 
            color: white; 
            padding: 14px 8px; 
            text-align: left; 
            font-weight: 600; 
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .sequence-table td { 
            padding: 12px 8px; 
            border-bottom: 1px solid var(--border); 
        }
        
        .sequence-table tr:nth-child(even) { 
            background: var(--gray-extra-light); 
        }
        
        .sequence-table tr:hover { 
            background: #E3F2FD; 
        }

        .color-sequence { 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
            margin-top: 15px; 
        }
        
        .color-item {
            display: flex; 
            align-items: center; 
            gap: 12px;
            padding: 15px; 
            background: white;
            border-radius: var(--radius); 
            border-left: 4px solid var(--primary);
            border: 1px solid var(--border); 
            border-left-width: 4px;
            transition: var(--transition);
        }
        
        .color-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .color-item .form-control[title="Letra/Número de Pantalla"] {
            width: 60px; 
            text-align: center; 
            font-weight: bold;
            border: 2px solid var(--accent);
            padding: 8px;
            border-radius: var(--radius);
        }

        .badge { 
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 11px; 
            font-weight: bold; 
            color: white; 
            text-transform: uppercase; 
            letter-spacing: 0.5px;
        }
        
        .badge-blocker { 
            background: var(--gray-dark); 
        }
        
        .badge-white { 
            background: var(--gray-medium); 
        }
        
        .badge-color { 
            background: var(--primary); 
        }

        /* File Upload & Preview Moderno */
        .file-upload-area {
            border: 2px dashed var(--border); 
            border-radius: var(--radius);
            padding: 40px; 
            text-align: center; 
            cursor: pointer;
            background: var(--gray-extra-light); 
            transition: var(--transition);
            position: relative;
        }
        
        .file-upload-area:hover { 
            border-color: var(--primary); 
            background: rgba(211, 47, 47, 0.05); 
        }
        
        .file-upload-area i {
            font-size: 2.5rem; 
            color: var(--primary); 
            margin-bottom: 15px;
        }
        
        .image-preview { 
            max-width: 100%; 
            max-height: 250px; 
            border-radius: var(--radius); 
            margin-top: 15px; 
            display: none; 
            box-shadow: var(--shadow); 
            border: 1px solid var(--border); 
        }

        /* Dashboard Moderno */
        .dashboard-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        
        .stat-card { 
            background: white; 
            padding: 25px; 
            border-radius: var(--radius-lg); 
            box-shadow: var(--shadow); 
            text-align: center; 
            border-top: 4px solid var(--accent);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(to right, var(--primary), var(--accent));
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        .stat-number { 
            font-size: 2.8rem; 
            font-weight: bold; 
            color: var(--primary); 
            margin-bottom: 5px;
        }
        
        .stat-label { 
            font-size: 0.9rem; 
            color: var(--text-light);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Status Messages Modernos */
        .status-message {
            position: fixed; 
            bottom: 20px; 
            right: 20px;
            padding: 16px 24px; 
            border-radius: var(--radius);
            color: white; 
            font-weight: bold; 
            display: none;
            box-shadow: var(--shadow-lg); 
            z-index: 1000;
            animation: slideIn 0.3s ease;
            border-left: 4px solid rgba(255,255,255,0.5);
        }
        
        .status-success { 
            background: var(--success); 
        }
        
        .status-error { 
            background: var(--error); 
        }
        
        .status-warning { 
            background: var(--warning); 
        }
        
        @keyframes slideIn { 
            from { 
                transform: translateX(100px); 
                opacity: 0; 
            } 
            to { 
                transform: translateX(0); 
                opacity: 1; 
            } 
        }

        /* Logos Footer Moderno */
        .logos-container {
            text-align: center; 
            padding: 30px;
            background: var(--gray-dark);
            border-top: 1px solid var(--border);
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 40px;
        }
        
        .logos-container svg {
            filter: brightness(0) invert(1);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .logo-section {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .client-section {
                margin-left: 0;
            }
            
            .header-actions {
                align-items: flex-start;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        @media print {
            .no-print, .app-nav, .header-actions { display: none !important; }
            .app-container { box-shadow: none; border: none; }
            body { background: white; }
            .card { box-shadow: none; border: 1px solid #ddd; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="logo-section">
                <div class="app-logo">
                    <svg viewBox="0 0 145.94 39.05" xmlns="http://www.w3.org/2000/svg">
                        <path d="M42.24,12.37v1.93h6.91v15.25h4.21v-15.25h6.91v-3.88h-16.1l-1.93,1.95ZM92.06,20.31v1.87h4.24v2.73c-.53.38-1.13.67-1.8.86-.67.19-1.39.29-2.16.29-.84,0-1.61.15-2.32-.45-.71-.3-1.33-.72-1.84-1.27-.52-.55-.92-1.19-1.2-1.93-.28-.74-.42-1.54-.42-2.42v-.05c0-.82.14-1.59.42-2.31.28-.72.67-1.35,1.18-1.89.5-.54,1.08-.97,1.75-1.28.66-.32,1.38-.48,2.15-.48.55,0,1.05.05,1.5.14.46.09.88.22,1.27.38.39.16.77.36,1.13.6.25.16.49.34.74.54l2.94-2.97c-.47-.4-.96-.75-1.46-1.07-.53-.33-1.09-.6-1.7-.82-.6-.22-1.25-.39-1.95-.51-.7-.12-1.48-.18-2.34-.18-1.44,0-2.77.26-4,.78-1.23.52-2.29,1.23-3.18,2.13-.89.9-1.59,1.95-2.09,3.14-.50,1.19-.75,2.47-.75,3.84v.05c0,1.42.25,2.73.74,3.94.49,1.2,1.18,2.24,2.06,3.12.88.87,1.94,1.56,3.17,2.05,1.23.49,2.59.74,4.09.74,1.75,0,3.3-.3,4.66-.89,1.36-.59,2.53-1.31,3.51-2.15v-8.31h-6.56l-1.74,1.76ZM68.15,21.8h9.02v-3.74h-9.02v-3.88h10.25v-3.74h-12.55l-1.86,1.88v17.26h14.54v-3.74h-10.39v-4.02ZM114.24,10.43h-8.75v19.13h4.21v-6.12h3.31l4.1,6.12h2.57l1.39-1.4-3.71-5.43c1.22-.46,2.21-1.17,2.97-2.15.76-.97,1.13-2.24,1.13-3.79v-.05c0-1.82-.55-3.28-1.64-4.37-1.29-1.29-3.15-1.94-5.58-1.94ZM117.19,17.03c0,.82-.28,1.48-.83,1.98-.56.49-1.35.74-2.39.74h-4.26v-5.52h4.18c1.04,0,1.85.23,2.43.69.58.46.87,1.14.87,2.06v.05ZM136.7,10.29h-3.88l-8.2,19.27h4.29l1.75-4.29h8.09l1.75,4.29h1.97l1.7-1.72-7.47-17.55ZM132.16,21.58l2.54-6.2,2.54,6.2h-5.08Z"/>
                        <g><polygon points="7.44 31.38 6.59 32.24 6.88 33.39 8.03 33.68 8.89 32.83 8.59 31.68 7.44 31.38"/><polygon points="6.79 28.67 7.94 28.97 10.41 26.5 10.11 25.35 8.96 25.05 6.49 27.52 6.79 28.67"/><polygon points="10.54 14.61 9.4 14.31 6.93 16.78 7.23 17.93 8.37 18.23 10.85 15.76 10.54 14.61"/><polygon points="26.38 22.79 25.06 24.11 25.36 25.26 26.5 25.56 27.82 24.24 27.52 23.09 26.38 22.79"/><path d="M21.9,36.93l.3,1.15,1.15.3.85-.85-.3-1.15-1.15-.3-.85.85ZM18.01,29.21l-.3-1.15.85-.85,1.15.3.3,1.15-.85.85-1.15-.3ZM18.83,19.56l-.3-1.15,1.5-1.5,1.15.3.3,1.15-1.5,1.5-1.15-.3ZM20.85,14.61l-.3-1.15,1.5-1.5,1.15.3.3,1.15-1.5,1.5-1.15-.3ZM14.33,15.34l-.3-1.14,3.78-3.68,1.14.3.3,1.14-3.78,3.68-1.15-.3ZM24.21,10.68l-.3-1.15,2.17-2.17,1.14.3.3,1.14-2.17,2.17-1.14-.3ZM20.59,9.12l-.3-1.15.85-.85,1.15.3.3,1.15-.85.85-1.15-.3ZM15.06,8.82l-.3-1.15,1.5-1.5,1.15.3.3,1.15-1.5,1.5-1.15-.3ZM25.51,0l-4.9,4.9-1.14-.3-.3-1.14,3.46-3.46H0v9.55h4.54l-1.67,1.67.3,1.14,1.15.3,3.12-3.12h.02l2.59-2.59,1.14.3.3,1.14-.57.57-1.81,1.78.3,1.15,1.15.3,2.5-2.45v8.41l-3.99,3.99.3,1.15,1.15.3,4.62-4.62,1.07.28.3,1.15-1.42,1.42-.93.93-.84.84-1.78,1.78.3,1.15,1.14.3,3.56-3.56.27-.27,1.14.3.3,1.14-4.64,4.64h-.03s-2.52,2.51-2.52,2.51l.31,1.16,1.17.31,2.52-2.52h0s.3-.32.3-.32l1.14.3.3,1.15-3.75,3.75h0s-2.17,2.18-2.17,2.18l.3,1.14,1.15.3,6.35-6.35,1.14.3.3,1.15-2.82,2.77.3,1.14,1.15.3,5.15-5.1v-2.89h0s-1.24,1.24-1.24,1.24l-1.15-.3-.3-1.14,3.43-3.41-.3-1.15-.45-.12-.71-.19-1.05,1.05-1.14-.3-.3-1.14,6.16-6.31-.3-1.15-1.14-.3-1.51,1.51v-4.34l5.25-4.76h7.28V0h-10.92Z"/></g>
                    </svg>
                </div>
                <div>
                    <h1 class="app-title">Technical Spec Manager</h1>
                    <p class="app-subtitle">Sistema de gestión de especificaciones técnicas</p>
                </div>
                
                <div class="client-section">
                    <span class="client-label">CUSTOMER / CLIENTE:</span>
                    <div class="client-logo-wrapper">
                        <svg id="logoCliente" width="80" height="30" viewBox="0 0 100 35"></svg>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <div class="folder-input-container">
                     <span class="client-label" style="font-size: 0.9rem; color: white;"># FOLDER:</span>
                     <input type="text" id="folder-num" class="form-control" placeholder="#####">
                </div>
                <div id="current-datetime"></div>
            </div>
        </header>

        <nav class="app-nav no-print">
            <ul class="nav-tabs">
                <li class="nav-tab active" onclick="showTab('dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</li>
                <li class="nav-tab" onclick="showTab('spec-creator')"><i class="fas fa-file-alt"></i> Crear Spec</li>
                <li class="nav-tab" onclick="showTab('saved-specs')"><i class="fas fa-database"></i> Guardadas</li>
            </ul>
        </nav>

        <main class="app-main">
            <div id="dashboard" class="tab-content active">
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-specs">0</div>
                        <div class="stat-label">Specs Totales</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="today-specs">0</div>
                        <div class="stat-label">Creadas Hoy</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="active-projects">0</div>
                        <div class="stat-label">Proyectos Activos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="completion-rate">0%</div>
                        <div class="stat-label">Tasa de Finalización</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body" style="text-align: center;">
                        <h2 style="color: var(--primary); margin-bottom: 20px;"><i class="fas fa-rocket"></i> Acciones Rápidas</h2>
                        <div style="margin-top: 20px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                            <button class="btn btn-primary btn-lg" onclick="showTab('spec-creator')"><i class="fas fa-plus"></i> Nueva Spec</button>
                            <button class="btn btn-success btn-lg" onclick="document.getElementById('excelFile').click()"><i class="fas fa-file-excel"></i> Cargar Excel</button>
                            <button class="btn btn-outline btn-lg" onclick="loadSavedSpecsList(); showTab('saved-specs')"><i class="fas fa-history"></i> Ver Historial</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="spec-creator" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-info-circle"></i> Información General</h2>
                        <div class="no-print">
                            <button class="btn btn-warning btn-sm" onclick="document.getElementById('excelFile').click()">
                                <i class="fas fa-file-excel"></i> Cargar Excel
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">CLIENTE:</label>
                                <input type="text" id="customer" class="form-control" oninput="updateClientLogo()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">STYLE:</label>
                                <input type="text" id="style" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">COLORWAY:</label>
                                <input type="text" id="colorway" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">SEASON:</label>
                                <input type="text" id="season" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">PATTERN #:</label>
                                <input type="text" id="pattern" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">P.O. #:</label>
                                <input type="text" id="po" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">SAMPLE TYPE:</label>
                                <input type="text" id="sample-type" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">NAME / TEAM:</label>
                                <input type="text" id="name-team" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">GENDER:</label>
                                <input type="text" id="gender" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">DISEÑADOR:</label>
                                <select id="designer" class="form-control">
                                    <option value="">Seleccionar...</option>
                                    <option value="ELMER VELEZ">ELMER VELEZ</option>
                                    <option value="DANIEL HERNANDEZ">DANIEL HERNANDEZ</option>
                                    <option value="CINDY PINEDA">CINDY PINEDA</option>
                                    <option value="EDA">EDA</option>
                                    <option value="OTRO">OTRO</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-image"></i> Imagen de Referencia</h2>
                    </div>
                    <div class="card-body">
                        <div class="file-upload-area" onclick="document.getElementById('imageInput').click()">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Haz clic para subir una imagen de referencia</p>
                            <p style="font-size: 0.8rem; color: var(--text-light); margin-top: 5px;">Formatos soportados: JPG, PNG, GIF</p>
                        </div>
                        <img id="imagePreview" class="image-preview" alt="Vista previa">
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-palette"></i> Colores y Tintas</h2>
                    </div>
                    <div class="card-body">
                        <div class="no-print" style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-danger btn-sm" onclick="addColorItem('BLOCKER')"><i class="fas fa-plus"></i> Blocker</button>
                            <button class="btn btn-white-base btn-sm" onclick="addColorItem('WHITE_BASE')"><i class="fas fa-plus"></i> White Base</button>
                            <button class="btn btn-primary btn-sm" onclick="addColorItem('COLOR')"><i class="fas fa-plus"></i> Color</button>
                        </div>
                        <div id="colors-container" class="color-sequence"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-print"></i> Condiciones de Impresión</h2>
                    </div>
                    <div class="card-body">
                        <div class="form-grid" style="margin-bottom: 20px;">
                             <div class="form-group">
                                <label class="form-label">TIPO DE TINTA:</label>
                                <select id="ink-type-select" class="form-control" onchange="applyInkPreset()">
                                    <option value="WATER">Water-base</option>
                                    <option value="PLASTISOL">Plastisol</option>
                                    <option value="SILICONE">Silicone</option>
                                </select>
                            </div>
                            <div class="form-group"><label class="form-label">INK TYPE:</label><input type="text" id="ink-type" class="form-control" value="AQUAFLEX MAGNA"></div>
                            <div class="form-group"><label class="form-label">TEMP:</label><input type="text" id="temp" class="form-control" value="320 °F"></div>
                            <div class="form-group"><label class="form-label">TIME:</label><input type="text" id="time" class="form-control" value="1:40 min"></div>
                            
                            <div class="form-group">
                                <label class="form-label">DIMENSIONS:</label>
                                <input type="text" id="dimensions" class="form-control" value='SIZE: (W) ##" X (H) ##"'>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">PLACEMENT (Ubicación):</label>
                                <select id="placement-select" class="form-control">
                                    <option value="FRONT">FRONT</option>
                                    <option value="BACK">BACK</option>
                                    <option value="TV. NUMBERS">TV. NUMBERS</option>
                                    <option value="SLEEVE">SLEEVE</option>
                                    <option value="CHEST">CHEST</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">PLACEMENT DETAILS:</label>
                                <input type="text" id="placement" class="form-control" value='#.#" FROM COLLAR SEAM'>
                            </div>

                            <div class="form-group">
                                <label class="form-label">SPECIALTIES:</label>
                                <input type="text" id="specialties" class="form-control" placeholder="Ej: HD, Metalico, Puff..." onchange="this.dataset.manual = 'true'">
                            </div>
                        </div>
                        
                        <h3 style="margin: 20px 0 15px 0; font-size:1rem; color:var(--primary); border-bottom: 2px solid var(--accent); padding-bottom: 8px; display:inline-block;">
                            <i class="fas fa-list-ol"></i> Secuencia de Estaciones
                        </h3>
                        <div id="print-sequence-table"></div>
                        
                         <div class="form-group" style="margin-top: 25px;">
                            <label class="form-label">SPECIAL INSTRUCTIONS:</label>
                            <textarea id="special-instructions" class="form-control" rows="3" placeholder="Instrucciones especiales para la producción..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="card no-print">
                    <div class="card-body" style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
                        <button class="btn btn-primary btn-lg" onclick="downloadJSON()"><i class="fas fa-download"></i> Guardar / Descargar JSON</button>
                        <button class="btn btn-success btn-lg" onclick="exportPDF()"><i class="fas fa-file-pdf"></i> Exportar PDF</button>
                        <button class="btn btn-outline btn-lg" onclick="clearForm()"><i class="fas fa-broom"></i> Limpiar Formulario</button>
                    </div>
                </div>
            </div>

            <div id="saved-specs" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-database"></i> Specs Guardadas (Browser)</h2>
                        <button class="btn btn-outline btn-sm" onclick="clearAllSpecs()">
                            <i class="fas fa-trash"></i> Limpiar Todo
                        </button>
                    </div>
                    <div class="card-body" id="saved-specs-list">
                        <p style="text-align: center; color: var(--text-light); padding: 20px;">
                            <i class="fas fa-database" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                            No hay specs guardadas. Crea una nueva spec para verla aquí.
                        </p>
                    </div>
                </div>
            </div>
        </main>

        <div class="logos-container">
            <svg width="150" height="40" viewBox="0 0 145.94 39.05" xmlns="http://www.w3.org/2000/svg">
                <path fill="#ffffff" d="M42.24,12.37v1.93h6.91v15.25h4.21v-15.25h6.91v-3.88h-16.1l-1.93,1.95ZM92.06,20.31v1.87h4.24v2.73c-.53.38-1.13.67-1.8.86-.67.19-1.39.29-2.16.29-.84,0-1.61.15-2.32-.45-.71-.3-1.33-.72-1.84-1.27-.52-.55-.92-1.19-1.2-1.93-.28-.74-.42-1.54-.42-2.42v-.05c0-.82.14-1.59.42-2.31.28-.72.67-1.35,1.18-1.89.5-.54,1.08-.97,1.75-1.28.66-.32,1.38-.48,2.15-.48.55,0,1.05.05,1.5.14.46.09.88.22,1.27.38.39.16.77.36,1.13.6.25.16.49.34.74.54l2.94-2.97c-.47-.4-.96-.75-1.46-1.07-.53-.33-1.09-.6-1.7-.82-.6-.22-1.25-.39-1.95-.51-.7-.12-1.48-.18-2.34-.18-1.44,0-2.77.26-4,.78-1.23.52-2.29,1.23-3.18,2.13-.89.9-1.59,1.95-2.09,3.14-.50,1.19-.75,2.47-.75,3.84v.05c0,1.42.25,2.73.74,3.94.49,1.2,1.18,2.24,2.06,3.12.88.87,1.94,1.56,3.17,2.05,1.23.49,2.59.74,4.09.74,1.75,0,3.3-.3,4.66-.89,1.36-.59,2.53-1.31,3.51-2.15v-8.31h-6.56l-1.74,1.76ZM68.15,21.8h9.02v-3.74h-9.02v-3.88h10.25v-3.74h-12.55l-1.86,1.88v17.26h14.54v-3.74h-10.39v-4.02ZM114.24,10.43h-8.75v19.13h4.21v-6.12h3.31l4.1,6.12h2.57l1.39-1.4-3.71-5.43c1.22-.46,2.21-1.17,2.97-2.15.76-.97,1.13-2.24,1.13-3.79v-.05c0-1.82-.55-3.28-1.64-4.37-1.29-1.29-3.15-1.94-5.58-1.94ZM117.19,17.03c0,.82-.28,1.48-.83,1.98-.56.49-1.35.74-2.39.74h-4.26v-5.52h4.18c1.04,0,1.85.23,2.43.69.58.46.87,1.14.87,2.06v.05ZM136.7,10.29h-3.88l-8.2,19.27h4.29l1.75-4.29h8.09l1.75,4.29h1.97l1.7-1.72-7.47-17.55ZM132.16,21.58l2.54-6.2,2.54,6.2h-5.08Z"/>
                <g><polygon fill="#ffffff" points="7.44 31.38 6.59 32.24 6.88 33.39 8.03 33.68 8.89 32.83 8.59 31.68 7.44 31.38"/><polygon fill="#ffffff" points="6.79 28.67 7.94 28.97 10.41 26.5 10.11 25.35 8.96 25.05 6.49 27.52 6.79 28.67"/><polygon fill="#ffffff" points="10.54 14.61 9.4 14.31 6.93 16.78 7.23 17.93 8.37 18.23 10.85 15.76 10.54 14.61"/><polygon fill="#ffffff" points="26.38 22.79 25.06 24.11 25.36 25.26 26.5 25.56 27.82 24.24 27.52 23.09 26.38 22.79"/><path fill="#ffffff" d="M21.9,36.93l.3,1.15,1.15.3.85-.85-.3-1.15-1.15-.3-.85.85ZM18.01,29.21l-.3-1.15.85-.85,1.15.3.3,1.15-.85.85-1.15-.3ZM18.83,19.56l-.3-1.15,1.5-1.5,1.15.3.3,1.15-1.5,1.5-1.15-.3ZM20.85,14.61l-.3-1.15,1.5-1.5,1.15.3.3,1.15-1.5,1.5-1.15-.3ZM14.33,15.34l-.3-1.14,3.78-3.68,1.14.3.3,1.14-3.78,3.68-1.15-.3ZM24.21,10.68l-.3-1.15,2.17-2.17,1.14.3.3,1.14-2.17,2.17-1.14-.3ZM20.59,9.12l-.3-1.15.85-.85,1.15.3.3,1.15-.85.85-1.15-.3ZM15.06,8.82l-.3-1.15,1.5-1.5,1.15.3.3,1.15-1.5,1.5-1.15-.3ZM25.51,0l-4.9,4.9-1.14-.3-.3-1.14,3.46-3.46H0v9.55h4.54l-1.67,1.67.3,1.14,1.15.3,3.12-3.12h.02l2.59-2.59,1.14.3.3,1.14-.57.57-1.81,1.78.3,1.15,1.15.3,2.5-2.45v8.41l-3.99,3.99.3,1.15,1.15.3,4.62-4.62,1.07.28.3,1.15-1.42,1.42-.93.93-.84.84-1.78,1.78.3,1.15,1.14.3,3.56-3.56.27-.27,1.14.3.3,1.14-4.64,4.64h-.03s-2.52,2.51-2.52,2.51l.31,1.16,1.17.31,2.52-2.52h0s.3-.32.3-.32l1.14.3.3,1.15-3.75,3.75h0s-2.17,2.18-2.17,2.18l.3,1.14,1.15.3,6.35-6.35,1.14.3.3,1.15-2.82,2.77.3,1.14,1.15.3,5.15-5.1v-2.89h0s-1.24,1.24-1.24,1.24l-1.15-.3-.3-1.14,3.43-3.41-.3-1.15-.45-.12-.71-.19-1.05,1.05-1.14-.3-.3-1.14,6.16-6.31-.3-1.15-1.14-.3-1.51,1.51v-4.34l5.25-4.76h7.28V0h-10.92Z"/></g>
            </svg>
        </div>

        <div id="statusMessage" class="status-message"></div>
    </div>

    <input type="file" id="excelFile" accept=".xlsx, .xls, .json" style="display: none;">
    <input type="file" id="imageInput" accept="image/*" style="display: none;">

    <script>
        // ========== VARIABLES GLOBALES ==========
        let colorSequence = [];
        
        const INK_PRESETS = {
            WATER: {
                temp: '320 °F', time: '1:40 min',
                blocker: { name: 'BLOCKER rubber black', mesh1: '122/55', mesh2: '157/48', durometer: '70', strokes: '2', additives: '3 % cross-linker 500 · 1.5 % antitack' },
                white: { name: 'AQUAFLEX WHITE', mesh1: '198/40', mesh2: '157/48', durometer: '70', strokes: '2', additives: '3 % cross-linker 500 · 1.5 % antitack' },
                color: { mesh: '157/48', durometer: '70', strokes: '2', additives: '3 % cross-linker 500 · 1.5 % antitack' }
            },
            PLASTISOL: {
                temp: '320 °F', time: '0:45 min',
                blocker: { name: 'BLOCKER plastisol', mesh1: '110/64', mesh2: '156/64', durometer: '65', strokes: '1', additives: '1 % catalyst' },
                white: { name: 'PLASTISOL WHITE', mesh1: '156/64', mesh2: '110/64', durometer: '65', strokes: '1', additives: '1 % catalyst' },
                color: { mesh: '156/64', durometer: '65', strokes: '1', additives: '1 % catalyst' }
            },
            SILICONE: {
                temp: '320 °F', time: '1:40 min',
                blocker: { name: 'BLOCKER silicone', mesh1: '110/64', mesh2: '157/48', durometer: '70', strokes: '2', additives: '3 % cat · 2 % ret' },
                white: { name: 'WHITE LIBRA', mesh1: '122/55', mesh2: '157/48', durometer: '70', strokes: '2', additives: '3 % cat · 2 % ret' },
                color: { mesh: '157/48', durometer: '70', strokes: '2', additives: '3 % cat · 2 % ret' }
            }
        };

        // ========== NAVEGACIÓN Y UI ==========
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => {
                if (tab.innerText.toLowerCase().includes(tabName.replace('-', ' '))) tab.classList.add('active');
            });
            
            if (tabName === 'saved-specs') loadSavedSpecsList();
            if (tabName === 'dashboard') updateDashboard();
        }

        function showStatus(msg, type = 'success') {
            const el = document.getElementById('statusMessage');
            el.textContent = msg;
            el.className = `status-message status-${type}`;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 4000);
        }
        
        function updateDateTime() {
            const now = new Date();
            const options = { weekday:'long', year:'numeric', month:'long', day:'numeric', hour: '2-digit', minute: '2-digit' };
            document.getElementById('current-datetime').textContent = now.toLocaleDateString('es-ES', options);
        }

        function updateDashboard() {
            const specs = Object.keys(localStorage).filter(k => k.startsWith('spec_'));
            const total = specs.length;
            document.getElementById('total-specs').textContent = total;
            
            // Calcular specs de hoy
            const today = new Date().toDateString();
            let todayCount = 0;
            specs.forEach(key => {
                try {
                    const data = JSON.parse(localStorage.getItem(key));
                    if (data.savedAt && new Date(data.savedAt).toDateString() === today) {
                        todayCount++;
                    }
                } catch(e) {}
            });
            document.getElementById('today-specs').textContent = todayCount;
            
            // Estadísticas adicionales
            document.getElementById('active-projects').textContent = Math.floor(total * 0.7);
            document.getElementById('completion-rate').textContent = Math.floor((todayCount / Math.max(total, 1)) * 100) + '%';
        }

        // ========== DETECCIÓN DE SPECIALTIES ==========
        function updateSpecialties() {
            const specsField = document.getElementById('specialties');
            if (specsField.dataset.manual === 'true') return; 

            const keywords = ['HD', 'HIGH DENSITY', 'PUFF', 'METALLIC', 'METALICO', 'METÁLICO', 'FOIL', 'GLITTER', 'SHIMMER', 'GEL', 'FLOCK', 'REFLECTIVE', 'SUEDE', 'DISCHARGE'];
            const customKeyword = document.getElementById('customer').value.toUpperCase().includes('UN872C') ? 'UN872C' : null;

            let detected = [];
            
            document.querySelectorAll('[id^="ink-"]').forEach(input => {
                const val = input.value.toUpperCase();
                keywords.forEach(kw => {
                    if (val.includes(kw) && !detected.includes(kw)) {
                        detected.push(kw);
                    }
                });
            });
            
            if (customKeyword && !detected.includes(customKeyword)) {
                 detected.push(customKeyword);
            }

            if (detected.length > 0) {
                specsField.value = detected.join(', ');
            } else {
                specsField.value = '';
            }
        }

        // ========== GESTIÓN DE COLORES ==========
        function updateScreenLetter(id, value) {
            const item = colorSequence.find(c => c.id === parseInt(id));
            if (item) {
                item.screenLetter = value;
                updateStations();
            }
        }

        function addColorItem(type) {
            const currentValues = {};
            document.querySelectorAll('[id^="ink-"]').forEach(input => {
                const id = input.id.split('-')[1];
                const letterInput = document.getElementById(`letter-${id}`);
                currentValues[`ink_${id}`] = input.value;
                if (letterInput) currentValues[`letter_${id}`] = letterInput.value;
            });
        
            let initialLetter = '';
            
            if (type === 'BLOCKER') {
                initialLetter = 'A';
            } else if (type === 'WHITE_BASE') {
                initialLetter = 'B';
            } else if (type === 'COLOR') {
                let maxColorNum = 0;
                colorSequence.filter(c => c.type !== 'BLOCKER' && c.type !== 'WHITE_BASE').forEach(c => {
                     const letter = c.screenLetter;
                     const num = parseInt(letter);
                     if (!isNaN(num) && num > 0) {
                         maxColorNum = Math.max(maxColorNum, num);
                     }
                });
                initialLetter = String(maxColorNum + 1);
            }
            
            colorSequence.push({ id: Date.now(), type, screenLetter: initialLetter });
            renderColors(currentValues);
            updateStations();
            applyInkPreset(); 
        }

        function removeColorItem(id) {
            const currentValues = {};
            document.querySelectorAll('[id^="ink-"]').forEach(input => {
                const currentId = input.id.split('-')[1];
                if(currentId != id) {
                    const letterInput = document.getElementById(`letter-${currentId}`);
                    currentValues[`ink_${currentId}`] = input.value;
                    if (letterInput) currentValues[`letter_${currentId}`] = letterInput.value;
                }
            });
            
            colorSequence = colorSequence.filter(i => i.id !== id);
            renderColors(currentValues);
            updateStations();
            updateSpecialties();
        }

        function renderColors(savedValues = {}) {
            const container = document.getElementById('colors-container');
            container.innerHTML = '';
            
            const safeValues = savedValues || {};
            
            if (colorSequence.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: var(--text-light);">
                        <i class="fas fa-palette" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                        <p>No hay colores agregados. Usa los botones de arriba para agregar blockers, white base o colores.</p>
                    </div>
                `;
                return;
            }
            
            colorSequence.forEach((item) => {
                const badgeClass = item.type === 'BLOCKER' ? 'badge-blocker' : item.type === 'WHITE_BASE' ? 'badge-white' : 'badge-color';
                const label = item.type === 'BLOCKER' ? 'BLOQUEADOR' : item.type === 'WHITE_BASE' ? 'WHITE BASE' : 'COLOR';
                
                const div = document.createElement('div');
                div.className = 'color-item';
                
                const screenLetterValue = safeValues[`letter_${item.id}`] || item.screenLetter || '';

                div.innerHTML = `
                    <span class="badge ${badgeClass}">${label}</span>
                    <input type="text" style="width: 60px; text-align: center; font-weight: bold;" 
                           value="${screenLetterValue}" 
                           id="letter-${item.id}"
                           oninput="updateScreenLetter(${item.id}, this.value.toUpperCase())"
                           class="form-control" title="Letra/Número de Pantalla">

                    <input type="text" class="form-control" id="ink-${item.id}" placeholder="Nombre de la tinta..." onchange="updateStations(); updateSpecialties();">
                    <button class="btn btn-danger btn-sm" onclick="removeColorItem(${item.id})"><i class="fas fa-times"></i></button>
                `;
                container.appendChild(div);
                
                if (safeValues[`ink_${item.id}`] !== undefined) {
                    document.getElementById(`ink-${item.id}`).value = safeValues[`ink_${item.id}`];
                }

                item.screenLetter = screenLetterValue;
            });
            updateSpecialties(); 
        }

        // ========== TABLA DE IMPRESIÓN ==========
        function updateStations(returnOnly = false) {
            const type = document.getElementById('ink-type-select').value;
            const preset = INK_PRESETS[type];
            const stationsData = [];
            let stNum = 1;

            colorSequence.forEach((item, idx) => {
                const inkElement = document.getElementById(`ink-${item.id}`);
                const inkVal = inkElement ? inkElement.value : '---';
                let mesh, strokes, duro, add, screenLetter, screenTypeLabel;

                screenLetter = item.screenLetter.trim() || 'N/A';

                if (item.type === 'BLOCKER') {
                    screenTypeLabel = preset.blocker.name;
                    mesh = stNum <= 3 ? preset.blocker.mesh1 : preset.blocker.mesh2;
                    strokes = preset.blocker.strokes; duro = preset.blocker.durometer; add = preset.blocker.additives;
                } else if (item.type === 'WHITE_BASE') {
                    screenTypeLabel = preset.white.name;
                    mesh = stNum <= 9 ? preset.white.mesh1 : preset.white.mesh2;
                    strokes = preset.white.strokes; duro = preset.white.durometer; add = preset.white.additives;
                } else {
                    screenTypeLabel = inkVal;
                    mesh = preset.color.mesh;
                    strokes = preset.color.strokes; duro = preset.color.durometer; add = preset.color.additives;
                }
                
                const screenCombined = (item.type === 'BLOCKER' || item.type === 'WHITE_BASE') 
                               ? screenTypeLabel
                               : inkVal;
                
                stationsData.push({ 
                    st: stNum++, 
                    screenLetter: screenLetter,
                    screenCombined: screenCombined,
                    mesh: mesh, 
                    ink: inkVal,
                    strokes: strokes, 
                    duro: duro, 
                    add: add 
                });

                if (idx < colorSequence.length - 1) {
                    stationsData.push({ st: stNum++, screenLetter: '', screenCombined: 'FLASH', mesh: '-', ink: '-', strokes: '-', duro: '-', add: '' });
                    stationsData.push({ st: stNum++, screenLetter: '', screenCombined: 'COOL', mesh: '-', ink: '-', strokes: '-', duro: '-', add: '' });
                }
            });
            
            if (returnOnly) return stationsData;
            
            renderStationsTable(stationsData);
        }

        function renderStationsTable(data) {
            const div = document.getElementById('print-sequence-table');
            if (data.length === 0) {
                div.innerHTML = '<p style="color:var(--text-light); font-style:italic; text-align:center; padding:30px; background:var(--gray-extra-light); border-radius:var(--radius);">Agrega colores arriba para generar la secuencia de impresión.</p>';
                return;
            }
            
            let html = `<table class="sequence-table">
                <thead><tr>
                    <th>Est</th>
                    <th>Screen Letter / Pantalla</th>
                    <th>Screen (Tinta/Proceso)</th>
                    <th>Aditivos</th>
                    <th>Malla</th>
                    <th>Golpes</th>
                    <th>Duro</th>
                </tr></thead><tbody>`;
            
            data.forEach(row => {
                html += `<tr>
                    <td><strong>${row.st}</strong></td>
                    <td><b style="color: var(--primary);">${row.screenLetter}</b></td>
                    <td>${row.screenCombined}</td>
                    <td style="font-size:11px; color:var(--primary); font-weight:600;">${row.add}</td>
                    <td>${row.mesh}</td>
                    <td>${row.strokes}</td>
                    <td>${row.duro}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            div.innerHTML = html;
        }

        function applyInkPreset() {
            const type = document.getElementById('ink-type-select').value;
            const preset = INK_PRESETS[type];
            document.getElementById('ink-type').value = type === 'WATER' ? 'AQUAFLEX MAGNA' : type;
            document.getElementById('temp').value = preset.temp;
            document.getElementById('time').value = preset.time;
            
            colorSequence.forEach(item => {
                const input = document.getElementById(`ink-${item.id}`);
                if (input && !input.value) {
                    if (item.type === 'BLOCKER') input.value = preset.blocker.name;
                    if (item.type === 'WHITE_BASE') input.value = preset.white.name;
                }
            });
            updateStations();
        }

        // ========== LOGOS CLIENTES ==========
        function updateClientLogo() {
            const val = document.getElementById('customer').value.toLowerCase();
            const container = document.getElementById('logoCliente');
            container.innerHTML = ''; 
            
            if (val.includes('nike')) {
                container.innerHTML = `<path fill="#fff" d="M27.16,19.5c-5.94,1.63-10.72,1.46-13.46-.54-7.02-5.12-1.79-15.56.11-18.67-3.4,3.82-6.78,7.64-9.41,11.81C.29,18.63-1.45,25.75,1.4,30.3c5.13,8.19,17.26,4.31,24.97.95L98.07,0,27.16,19.5Z"/>`;
            } else if (val.includes('fanatics')) {
                container.innerHTML = `<path fill="#fff" d="M60.38,11.14c-1.16,0-2.14.39-3.13,1.25v-.96c0-.08-.07-.15-.15-.15h-2.55c-.08,0-.15.07-.15.15v10.73c0,.08.07.15.15.15h2.64c.08,0,.15-.07.15-.15v-5.85c0-1.3,1.07-2.42,2.33-2.44h.05c1.65,0,2.24,1.3,2.24,2.51v5.78c0,.08.07.15.15.15h2.66c.08,0,.15-.07.15-.15v-5.8c0-3.12-1.82-5.22-4.54-5.22Z"/>
                    <path fill="#fff" d="M52.66,11.26h-2.63c-.08,0-.15.07-.15.15v.46c-.89-.7-1.98-.81-3.03-.81h-.05c-3.33,0-5.48,2.18-5.48,5.55,0,1.75.53,3.21,1.54,4.20.96.94,2.30,1.44,3.88,1.44h.16c.97-.02,2.05-.04,2.97-.89v.81c0,.08.07.15.15.15h2.63c.08,0,.15-.07.15-.15v-10.75c0-.08-.07-.15-.15-.15ZM49.30,18.55c-.50.58-1.38.94-2.23.94-1.67,0-2.80-1.16-2.80-2.88s1.12-2.86,2.80-2.86c2.03,0,2.87,1.44,2.87,2.83,0,.76-.20,1.46-.64,1.98Z"/>`;
            } else {
                // Logo por defecto - texto del cliente
                const text = document.getElementById('customer').value || 'CLIENTE';
                container.innerHTML = `<text x="50" y="20" text-anchor="middle" fill="#fff" font-family="Arial, sans-serif" font-size="14" font-weight="bold">${text.substring(0, 12)}</text>`;
            }
        }

        // ========== IMAGEN PREVIEW ==========
        document.getElementById('imageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Validar tipo de archivo
            if (!file.type.match('image.*')) {
                showStatus('❌ Por favor, selecciona un archivo de imagen válido', 'error');
                return;
            }
            
            // Validar tamaño (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showStatus('❌ La imagen es demasiado grande (máximo 5MB)', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(ev) {
                const img = document.getElementById('imagePreview');
                img.src = ev.target.result;
                img.style.display = 'block';
                showStatus('✅ Imagen cargada correctamente');
            };
            reader.onerror = function() {
                showStatus('❌ Error al cargar la imagen', 'error');
            };
            reader.readAsDataURL(file);
        });

        // ========== CARGA EXCEL / JSON ==========
        document.getElementById('excelFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            if (file.name.toLowerCase().endsWith('.json')) {
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        loadSpecData(data);
                        showStatus('✅ JSON cargado correctamente', 'success');
                    } catch (err) {
                        console.error('Error al cargar JSON:', err);
                        showStatus('❌ Error leyendo el archivo JSON', 'error');
                    }
                };
                reader.onerror = function() {
                    showStatus('❌ Error al leer el archivo', 'error');
                };
                reader.readAsText(file);
            } else { // Asume Excel (.xlsx, .xls)
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        const sheetPriority = ['Proto 1', 'Proto 2', 'Proto 3', 'Proto 4', 'Sheet1'];
                        let worksheet = null;
                        let sheetUsed = '';
                        
                        for (const sheetName of sheetPriority) {
                            if (workbook.SheetNames.includes(sheetName)) {
                                worksheet = workbook.Sheets[sheetName];
                                sheetUsed = sheetName;
                                break;
                            }
                        }
                        if (!worksheet) {
                            worksheet = workbook.Sheets[workbook.SheetNames[0]];
                            sheetUsed = workbook.SheetNames[0];
                        }

                        showStatus(`📊 Leyendo hoja: ${sheetUsed}`, 'success');
                        processExcelData(worksheet);
                        
                    } catch (err) { 
                        console.error('Error al cargar Excel:', err); 
                        showStatus('❌ Error leyendo el archivo Excel', 'error'); 
                    }
                };
                reader.onerror = function() {
                    showStatus('❌ Error al leer el archivo Excel', 'error');
                };
                reader.readAsArrayBuffer(file);
            }
        });

        function processExcelData(worksheet) {
            const data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            const extracted = {};

            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length < 3) continue;
                
                const label = String(row[1] || '').trim();
                const val = String(row[2] || '').trim();

                if (label.includes('CUSTOMER:')) extracted.customer = val;
                else if (label.includes('STYLE:')) {
                    extracted.style = val.split('\n')[0]; 
                    const styleUpper = val.toUpperCase();
                    const teamMatch = styleUpper.match(/\s([A-Z]{3})\s/);
                    if (teamMatch) extracted.team = teamMatch[1];
                    const genderMatch = styleUpper.match(/\s(M|W)\s/);
                    if (genderMatch) extracted.gender = genderMatch[1] === 'M' ? 'MALE' : 'FEMALE';
                }
                else if (label.includes('COLORWAY')) extracted.colorway = val;
                else if (label.includes('SEASON:')) extracted.season = val;
                else if (label.includes('PATTERN')) extracted.pattern = val;
                else if (label.includes('P.O.')) extracted.po = val;
                else if (label.includes('SAMPLE TYPE') || label.includes('SAMPLE:')) extracted.sample = val;
                else if (label.includes('FOLDER')) extracted.folder = val;
            }

            if (extracted.customer) document.getElementById('customer').value = extracted.customer;
            if (extracted.style) document.getElementById('style').value = extracted.style;
            if (extracted.folder) document.getElementById('folder-num').value = extracted.folder; 
            if (extracted.colorway) document.getElementById('colorway').value = extracted.colorway;
            if (extracted.season) document.getElementById('season').value = extracted.season;
            if (extracted.pattern) document.getElementById('pattern').value = extracted.pattern;
            if (extracted.po) document.getElementById('po').value = extracted.po;
            if (extracted.sample) document.getElementById('sample-type').value = extracted.sample;
            if (extracted.team) document.getElementById('name-team').value = extracted.team;
            if (extracted.gender) document.getElementById('gender').value = extracted.gender;

            updateClientLogo();
            if (Object.keys(extracted).length > 0) showStatus('✅ Datos de Excel extraídos correctamente', 'success');
        }

        // ========== FUNCIÓN: DESCARGAR JSON (CORREGIDA) ==========
        function downloadJSON() {
            try {
                const style = document.getElementById('style').value || 'SinEstilo';
                const data = collectData();
                
                // SOLUCIÓN: No guardar imágenes en localStorage para evitar QuotaExceededError
                const dataForStorage = {...data};
                delete dataForStorage.imageB64; // Eliminar imagen del almacenamiento
                
                // Intentar guardar en localStorage, pero si falla, continuar con la descarga
                try {
                    const storageKey = `spec_${style}_${Date.now()}`;
                    localStorage.setItem(storageKey, JSON.stringify(dataForStorage));
                    updateDashboard();
                } catch (storageError) {
                    console.warn('No se pudo guardar en localStorage:', storageError);
                    // Continuar con la descarga aunque falle el almacenamiento
                }
                
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `TegraSpec_${style}_${Date.now()}.json`);
                document.body.appendChild(downloadAnchorNode); 
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
                
                showStatus('✅ JSON descargado correctamente', 'success');
            } catch (error) {
                console.error('Error al descargar JSON:', error);
                showStatus('❌ Error al descargar JSON: ' + error.message, 'error');
            }
        }

        function collectData() {
             const imageSrc = document.getElementById('imagePreview').src;
             
             colorSequence.forEach(item => {
                 item.screenLetter = document.getElementById(`letter-${item.id}`)?.value || item.screenLetter;
             });

             return {
                customer: document.getElementById('customer').value,
                style: document.getElementById('style').value,
                folder: document.getElementById('folder-num').value,
                colorway: document.getElementById('colorway').value,
                season: document.getElementById('season').value,
                pattern: document.getElementById('pattern').value,
                po: document.getElementById('po').value,
                sampleType: document.getElementById('sample-type').value,
                nameTeam: document.getElementById('name-team').value,
                gender: document.getElementById('gender').value,
                designer: document.getElementById('designer').value,
                colors: colorSequence.map(c => ({ 
                    id: c.id, 
                    type: c.type, 
                    val: document.getElementById(`ink-${c.id}`)?.value || '', 
                    screenLetter: c.screenLetter 
                })),
                inkType: document.getElementById('ink-type-select').value,
                dimensions: document.getElementById('dimensions').value,
                placementType: document.getElementById('placement-select').value,
                placement: document.getElementById('placement').value,
                specialties: document.getElementById('specialties').value,
                instructions: document.getElementById('special-instructions').value,
                imageB64: (imageSrc && imageSrc.startsWith('data:')) ? imageSrc : null, 
                savedAt: new Date().toISOString()
            };
        }

        // ========== GUARDAR/CARGAR STORAGE (CORREGIDO) ==========
        function loadSavedSpecsList() {
            const list = document.getElementById('saved-specs-list');
            const specs = Object.keys(localStorage).filter(key => key.startsWith('spec_'));
            
            if (specs.length === 0) {
                list.innerHTML = `
                    <p style="text-align: center; color: var(--text-light); padding: 30px;">
                        <i class="fas fa-database" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                        No hay specs guardadas. Crea una nueva spec para verla aquí.
                    </p>
                `;
                return;
            }
            
            list.innerHTML = '';
            specs.forEach(key => {
                try {
                    const data = JSON.parse(localStorage.getItem(key));
                    const div = document.createElement('div');
                    div.style.cssText = "padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; transition: var(--transition);";
                    div.innerHTML = `
                        <div style="flex: 1;">
                            <div style="font-weight: 700; color: var(--primary);">${data.style || 'N/A'}</div>
                            <div style="font-size: 0.85rem; color: var(--text-light);">Cliente: ${data.customer || 'N/A'} | Colorway: ${data.colorway || 'N/A'}</div>
                            <div style="font-size: 0.75rem; color: var(--gray-light);">Guardado: ${new Date(data.savedAt).toLocaleDateString('es-ES')}</div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-primary btn-sm" onclick='loadSpecData(${JSON.stringify(data)})'><i class="fas fa-edit"></i> Cargar</button>
                            <button class="btn btn-outline btn-sm" onclick="downloadSingleSpec('${key}')"><i class="fas fa-download"></i> JSON</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteSpec('${key}')"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    list.appendChild(div);
                } catch (e) {
                    console.error('Error al parsear spec guardada:', key, e);
                    // Eliminar entrada corrupta
                    localStorage.removeItem(key);
                }
            });
        }

        function downloadSingleSpec(key) {
            try {
                const data = JSON.parse(localStorage.getItem(key));
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `TegraSpec_${data.style || 'Backup'}.json`);
                document.body.appendChild(downloadAnchorNode); 
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
                showStatus('✅ Spec descargada como JSON', 'success');
            } catch (e) {
                showStatus('❌ Error al descargar la spec', 'error');
            }
        }

        function deleteSpec(key) {
            if (confirm('¿Estás seguro de que quieres eliminar esta spec?')) {
                localStorage.removeItem(key);
                loadSavedSpecsList();
                updateDashboard();
                showStatus('🗑️ Spec eliminada', 'success');
            }
        }

        function clearAllSpecs() {
            if (confirm('¿Estás seguro de que quieres eliminar TODAS las specs guardadas? Esta acción no se puede deshacer.')) {
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('spec_')) {
                        localStorage.removeItem(key);
                    }
                });
                loadSavedSpecsList();
                updateDashboard();
                showStatus('🗑️ Todas las specs han sido eliminadas', 'success');
            }
        }

        function loadSpecData(data) {
            document.getElementById('customer').value = data.customer || '';
            document.getElementById('style').value = data.style || '';
            document.getElementById('folder-num').value = data.folder || ''; 
            document.getElementById('colorway').value = data.colorway || '';
            document.getElementById('season').value = data.season || '';
            document.getElementById('pattern').value = data.pattern || '';
            document.getElementById('po').value = data.po || '';
            document.getElementById('sample-type').value = data.sampleType || '';
            document.getElementById('name-team').value = data.nameTeam || '';
            document.getElementById('gender').value = data.gender || '';
            document.getElementById('designer').value = data.designer || '';
            document.getElementById('ink-type-select').value = data.inkType || 'WATER';
            document.getElementById('dimensions').value = data.dimensions || '';
            document.getElementById('placement-select').value = data.placementType || 'FRONT';
            document.getElementById('placement').value = data.placement || '';
            document.getElementById('specialties').value = data.specialties || '';
            document.getElementById('special-instructions').value = data.instructions || '';
            
            // Las imágenes no se cargan desde localStorage (fueron eliminadas para evitar QuotaExceededError)
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('imagePreview').src = '';

            colorSequence = []; 
            const values = {};
            data.colors.forEach(c => {
                colorSequence.push({ id: c.id, type: c.type, screenLetter: c.screenLetter || '' }); 
                values[`ink_${c.id}`] = c.val;
                values[`letter_${c.id}`] = c.screenLetter || '';
            });
            
            renderColors(values);
            applyInkPreset();
            updateClientLogo();
            showTab('spec-creator');
            showStatus('📂 Spec cargada correctamente');
        }

        function clearForm() {
            if(confirm('¿Estás seguro de que quieres limpiar todo el formulario? Se perderán los datos no guardados.')) {
                document.querySelectorAll('input:not(#folder-num), textarea, select').forEach(i => {
                    if (i.type !== 'button' && i.type !== 'submit') {
                        i.value = '';
                    }
                });
                document.getElementById('designer').value = '';
                document.getElementById('ink-type-select').value = 'WATER';
                document.getElementById('placement-select').value = 'FRONT';
                document.getElementById('imagePreview').style.display = 'none';
                document.getElementById('imagePreview').src = '';
                colorSequence = []; 
                renderColors(); 
                updateStations();
                showStatus('🧹 Formulario limpiado correctamente');
            }
        }

        // ========== GENERACIÓN PDF (CORREGIDA) ==========
        function exportPDF() {
            try {
                if (typeof window.jspdf === 'undefined') {
                    showStatus('❌ Error: La biblioteca jsPDF no está cargada correctamente', 'error');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                
                if (typeof jsPDF === 'undefined') {
                    showStatus('❌ Error: No se pudo inicializar jsPDF', 'error');
                    return;
                }
                
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageW = pdf.internal.pageSize.getWidth();
                let y = 15;
                
                const primaryColor = [211, 47, 47]; // var(--primary-red)
                const accentColor = [255, 82, 82];  // var(--accent-red)
                
                const text = (str, x, yVal, size=10, bold=false, color=[0, 0, 0]) => {
                    pdf.setTextColor(...color); 
                    pdf.setFontSize(size);
                    pdf.setFont('helvetica', bold ? 'bold' : 'normal');
                    pdf.text(String(str || ''), x, yVal);
                };

                // Header con Logo TEGRA - SOLUCIÓN: Usar texto en lugar de SVG
                pdf.setFillColor(...primaryColor);
                pdf.rect(0, 0, pageW, 25, 'F');
                
                // Logo como texto en lugar de SVG
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(16); 
                pdf.setFont('helvetica', 'bold');
                pdf.text('TEGRA', 15, 12);
                
                pdf.setFontSize(14); 
                pdf.text('TECHNICAL SPEC MANAGER', 55, 12);
                pdf.setFontSize(10); 
                pdf.setFont('helvetica', 'normal');
                pdf.text('Sistema de gestión de especificaciones técnicas', 55, 17);
                
                // FOLDER #
                const folderNum = document.getElementById('folder-num').value || '#####';
                pdf.setFontSize(10); 
                pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(...accentColor);
                pdf.text('# FOLDER:', pageW - 40, 12);
                pdf.setTextColor(255, 255, 255);
                pdf.text(folderNum, pageW - 20, 12, { align: 'right' });

                // Información General
                y = 35;
                const fields = [
                    { l: 'CLIENTE:', v: document.getElementById('customer').value },
                    { l: 'STYLE:', v: document.getElementById('style').value },
                    { l: 'COLORWAY:', v: document.getElementById('colorway').value },
                    { l: 'SEASON:', v: document.getElementById('season').value },
                    { l: 'PATTERN #:', v: document.getElementById('pattern').value },
                    { l: 'P.O. #:', v: document.getElementById('po').value },
                    { l: 'SAMPLE TYPE:', v: document.getElementById('sample-type').value },
                    { l: 'TEAM:', v: document.getElementById('name-team').value },
                    { l: 'GENDER:', v: document.getElementById('gender').value },
                    { l: 'DESIGNER:', v: document.getElementById('designer').value },
                ];

                text('INFORMACIÓN GENERAL', 15, y, 12, true, primaryColor);
                y += 8;
                
                fields.forEach((f, i) => {
                    const xPos = i % 2 === 0 ? 15 : 110;
                    text(f.l, xPos, y, 9, true);
                    text(f.v || '---', xPos + 30, y, 9, false);
                    if (i % 2 !== 0) y += 6;
                });
                y += 10;

                // Imagen e Info de Impresión
                const img = document.getElementById('imagePreview');
                if (img.src && img.style.display !== 'none') {
                    try {
                        const imgH = 60;
                        // SOLUCIÓN: Usar formato JPEG/PNG en lugar de SVG
                        pdf.addImage(img.src, 'JPEG', 15, y, 60, imgH);
                        let yInk = y;
                        text('CONDICIONES DE IMPRESIÓN', 80, yInk, 11, true, primaryColor);
                        yInk += 6;
                        text('Temp: ' + (document.getElementById('temp').value || '---'), 80, yInk); yInk += 5;
                        text('Time: ' + (document.getElementById('time').value || '---'), 80, yInk); yInk += 5;
                        text('Type: ' + (document.getElementById('ink-type').value || '---'), 80, yInk); yInk += 5;
                        text('Dims: ' + (document.getElementById('dimensions').value || '---'), 80, yInk); yInk += 5;
                        text('Location: ' + (document.getElementById('placement-select').value || '---'), 80, yInk); yInk += 5;
                        text('Placement: ' + (document.getElementById('placement').value || '---'), 80, yInk); yInk += 5;
                        text('Specialties: ' + (document.getElementById('specialties').value || '---'), 80, yInk);
                        
                        y += imgH + 10;
                    } catch (e) { 
                        console.error('Error adding image to PDF:', e);
                        y += 10; 
                    }
                } else {
                    y += 10;
                }

                // Tabla Secuencia
                if (y > 220) { pdf.addPage(); y = 20; }
                text('SECUENCIA DE IMPRESIÓN', 15, y, 12, true, primaryColor);
                y += 8;

                const pdfHeaders = ['Est', 'Scr. Ltr', 'Screen (Tinta/Proceso)', 'Aditivos', 'Malla', 'Golpes', 'Duro'];
                const pdfColW = [8, 15, 65, 40, 15, 12, 12];
                let x = 15;
                
                pdf.setFillColor(...primaryColor); 
                pdf.rect(15, y - 5, 180, 8, 'F'); 
                pdf.setTextColor(255, 255, 255); 
                pdf.setFontSize(8);
                pdf.setFont('helvetica', 'bold');
                
                pdfHeaders.forEach((h, i) => {
                    pdf.text(h, x + 2, y);
                    x += pdfColW[i];
                });
                y += 6;

                pdf.setTextColor(0, 0, 0); 
                pdf.setFont('helvetica', 'normal');
                pdf.setFontSize(8);

                const tableData = updateStations(true); 
                
                tableData.forEach((row, idx) => {
                    if (y > 270) { pdf.addPage(); y = 20; }
                    
                    if (idx % 2 === 0) {
                        pdf.setFillColor(245, 245, 245);
                        pdf.rect(15, y - 4, 180, 6, 'F');
                    }
                    x = 15;
                    const data = [
                        row.st, row.screenLetter, row.screenCombined, 
                        row.add, row.mesh, row.strokes, row.duro
                    ];
                    const columnMaxLengths = [5, 10, 40, 30, 15, 10, 10]; 

                    data.forEach((d, i) => {
                        let safeText = String(d || '');
                        if (safeText.length > columnMaxLengths[i]) safeText = safeText.substring(0, columnMaxLengths[i]);
                        
                        if (i === 1) pdf.setFont('helvetica', 'bold'); 
                        if (i === 3) pdf.setTextColor(...accentColor); 

                        pdf.text(safeText, x + 2, y);
                        x += pdfColW[i];
                        
                        if (i === 1) pdf.setFont('helvetica', 'normal'); 
                        if (i === 3) pdf.setTextColor(0, 0, 0); 
                    });
                    y += 6;
                });

                // Instrucciones Especiales
                y += 5;
                const inst = document.getElementById('special-instructions').value;
                if (inst) {
                    if (y > 250) { pdf.addPage(); y = 20; }
                    pdf.setDrawColor(200);
                    pdf.rect(15, y, 180, 20);
                    text('INSTRUCCIONES ESPECIALES:', 17, y + 5, 9, true, primaryColor);
                    const splitText = pdf.splitTextToSize(inst, 170); 
                    pdf.text(splitText, 17, y + 10);
                }

                // Pie de página
                pdf.setFontSize(8);
                pdf.setTextColor(150);
                pdf.text('Generado por Tegra Technical Spec Manager', pageW / 2, 290, { align: 'center' });
                pdf.text(new Date().toLocaleDateString('es-ES'), pageW / 2, 293, { align: 'center' });

                pdf.save(`TegraSpec_${document.getElementById('style').value || 'Spec'}.pdf`);
                showStatus('✅ PDF generado correctamente');
            } catch (error) {
                console.error('Error al generar PDF:', error);
                showStatus('❌ Error al generar PDF: ' + error.message, 'error');
            }
        }

        // ========== INICIALIZACIÓN ==========
        document.addEventListener('DOMContentLoaded', () => {
             updateDateTime();
             updateDashboard();
             applyInkPreset();
             loadSavedSpecsList();
             
             // Actualizar la fecha cada minuto
             setInterval(updateDateTime, 60000);
        });
    </script>
</body>
</html>